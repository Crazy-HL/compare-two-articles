{"ast":null,"code":"import { createCommentVNode as _createCommentVNode, openBlock as _openBlock, createElementBlock as _createElementBlock, createElementVNode as _createElementVNode, Fragment as _Fragment, renderList as _renderList, toDisplayString as _toDisplayString, createTextVNode as _createTextVNode, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-35226a1e\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  class: \"field-visualization\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"pie-chart\",\n  ref: \"pieChart\"\n};\nconst _hoisted_3 = {\n  class: \"line-chart\",\n  ref: \"lineChart\"\n};\nconst _hoisted_4 = {\n  class: \"bar-chart\",\n  ref: \"barChart\"\n};\nconst _hoisted_5 = {\n  class: \"text-display\"\n};\nconst _hoisted_6 = {\n  key: 1,\n  class: \"no-data\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [$setup.hasData ? (_openBlock(), _createElementBlock(_Fragment, {\n    key: 0\n  }, [_createCommentVNode(\" 百分比饼图 \"), $setup.shouldShowPieChart ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, null, 512 /* NEED_PATCH */)) : $setup.shouldShowLineChart ? (_openBlock(), _createElementBlock(_Fragment, {\n    key: 1\n  }, [_createCommentVNode(\" 时间序列折线图 \"), _createElementVNode(\"div\", _hoisted_3, null, 512 /* NEED_PATCH */)], 2112 /* STABLE_FRAGMENT, DEV_ROOT_FRAGMENT */)) : $setup.shouldShowBarChart ? (_openBlock(), _createElementBlock(_Fragment, {\n    key: 2\n  }, [_createCommentVNode(\" 比较柱状图 \"), _createElementVNode(\"div\", _hoisted_4, null, 512 /* NEED_PATCH */)], 2112 /* STABLE_FRAGMENT, DEV_ROOT_FRAGMENT */)) : (_openBlock(), _createElementBlock(_Fragment, {\n    key: 3\n  }, [_createCommentVNode(\" 默认文本显示 \"), _createElementVNode(\"div\", _hoisted_5, [$setup.isArray ? (_openBlock(true), _createElementBlock(_Fragment, {\n    key: 0\n  }, _renderList($setup.processedArray, (item, index) => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: index\n    }, _toDisplayString($setup.formatDisplayValue(item)), 1 /* TEXT */);\n  }), 128 /* KEYED_FRAGMENT */)) : (_openBlock(), _createElementBlock(_Fragment, {\n    key: 1\n  }, [_createTextVNode(_toDisplayString($setup.formatDisplayValue($props.field)), 1 /* TEXT */)], 64 /* STABLE_FRAGMENT */))])], 2112 /* STABLE_FRAGMENT, DEV_ROOT_FRAGMENT */))], 64 /* STABLE_FRAGMENT */)) : (_openBlock(), _createElementBlock(\"div\", _hoisted_6, \"无数据\"))]);\n}","map":{"version":3,"names":["class","key","ref","_createElementBlock","_hoisted_1","$setup","hasData","_Fragment","_createCommentVNode","shouldShowPieChart","_hoisted_2","shouldShowLineChart","_createElementVNode","_hoisted_3","shouldShowBarChart","_hoisted_4","_hoisted_5","isArray","_renderList","processedArray","item","index","_toDisplayString","formatDisplayValue","_createTextVNode","$props","field","_hoisted_6"],"sources":["D:\\vue_frame\\vue_frame\\wikitable-vue\\client\\src\\components\\compoents_base\\FieldVisualization.vue"],"sourcesContent":["<template>\r\n\t<div class=\"field-visualization\">\r\n\t\t<template v-if=\"hasData\">\r\n\t\t\t<!-- 百分比饼图 -->\r\n\t\t\t<div v-if=\"shouldShowPieChart\" class=\"pie-chart\" ref=\"pieChart\"></div>\r\n\r\n\t\t\t<!-- 时间序列折线图 -->\r\n\t\t\t<div\r\n\t\t\t\tv-else-if=\"shouldShowLineChart\"\r\n\t\t\t\tclass=\"line-chart\"\r\n\t\t\t\tref=\"lineChart\"></div>\r\n\r\n\t\t\t<!-- 比较柱状图 -->\r\n\t\t\t<div\r\n\t\t\t\tv-else-if=\"shouldShowBarChart\"\r\n\t\t\t\tclass=\"bar-chart\"\r\n\t\t\t\tref=\"barChart\"></div>\r\n\r\n\t\t\t<!-- 默认文本显示 -->\r\n\t\t\t<div v-else class=\"text-display\">\r\n\t\t\t\t<template v-if=\"isArray\">\r\n\t\t\t\t\t<div v-for=\"(item, index) in processedArray\" :key=\"index\">\r\n\t\t\t\t\t\t{{ formatDisplayValue(item) }}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</template>\r\n\t\t\t\t<template v-else>\r\n\t\t\t\t\t{{ formatDisplayValue(field) }}\r\n\t\t\t\t</template>\r\n\t\t\t</div>\r\n\t\t</template>\r\n\t\t<div v-else class=\"no-data\">无数据</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, computed, onMounted, watch } from \"vue\";\r\n\timport * as d3 from \"d3\";\r\n\r\n\tconst props = defineProps({\r\n\t\tfield: [Object, Array, String, Number],\r\n\t\ttype: String,\r\n\t\tfieldKey: String\r\n\t});\r\n\r\n\tconst pieChart = ref(null);\r\n\tconst barChart = ref(null);\r\n\tconst lineChart = ref(null);\r\n\r\n\t// 数据清洗\r\n\tconst cleanValue = value => {\r\n\t\tif (value === null || value === undefined) return null;\r\n\t\tif (typeof value === \"number\") return value;\r\n\r\n\t\t// 特殊处理\"NaN ¥\"情况\r\n\t\tif (String(value).trim() === \"NaN ¥\") return \"人民币 (CNY)\";\r\n\r\n\t\t// 移除货币/百分比符号\r\n\t\tconst numValue = parseFloat(String(value).replace(/[$,%¥]/g, \"\"));\r\n\t\treturn isNaN(numValue) ? value : numValue;\r\n\t};\r\n\r\n\t// 处理后的数据\r\n\tconst processedArray = computed(() => {\r\n\t\tif (!Array.isArray(props.field)) return [];\r\n\r\n\t\treturn props.field\r\n\t\t\t.map(item => ({\r\n\t\t\t\tvalue: cleanValue(item.value),\r\n\t\t\t\tunit: item.unit,\r\n\t\t\t\tyear: item.year,\r\n\t\t\t\traw: item.value || item.raw\r\n\t\t\t}))\r\n\t\t\t.filter(item => item.value !== null);\r\n\t});\r\n\r\n\t// 显示逻辑判断\r\n\tconst shouldShowPieChart = computed(() => {\r\n\t\treturn (\r\n\t\t\tprops.type === \"percentage\" &&\r\n\t\t\t!Array.isArray(props.field) &&\r\n\t\t\ttypeof cleanValue(props.field?.value) === \"number\"\r\n\t\t);\r\n\t});\r\n\r\n\tconst shouldShowLineChart = computed(() => {\r\n\t\treturn (\r\n\t\t\tprocessedArray.value.length >= 2 &&\r\n\t\t\tprocessedArray.value.every(\r\n\t\t\t\titem => item.year && typeof item.value === \"number\"\r\n\t\t\t)\r\n\t\t);\r\n\t});\r\n\r\n\tconst shouldShowBarChart = computed(() => {\r\n\t\treturn (\r\n\t\t\tprocessedArray.value.length > 0 &&\r\n\t\t\tprocessedArray.value.length <= 3 &&\r\n\t\t\tprocessedArray.value.every(item => typeof item.value === \"number\")\r\n\t\t);\r\n\t});\r\n\r\n\tconst hasData = computed(() => {\r\n\t\tif (props.field === null || props.field === undefined) return false;\r\n\t\tif (Array.isArray(props.field)) return processedArray.value.length > 0;\r\n\t\treturn props.field.value !== undefined && props.field.value !== null;\r\n\t});\r\n\r\n\tconst isArray = computed(() => Array.isArray(props.field));\r\n\r\n\t// 格式化显示值\r\n\tconst formatDisplayValue = item => {\r\n\t\tconst value = item.value ?? item;\r\n\t\tif (value === null || value === undefined) return \"-\";\r\n\r\n\t\tif (typeof value === \"number\") {\r\n\t\t\tif (props.type === \"percentage\") return `${value}%`;\r\n\t\t\treturn value.toLocaleString() + (item.unit ? ` ${item.unit}` : \"\");\r\n\t\t}\r\n\r\n\t\t// 特殊字段处理\r\n\t\tif (props.fieldKey === \"Currency\" && value === \"NaN ¥\") {\r\n\t\t\treturn \"人民币 (CNY)\";\r\n\t\t}\r\n\r\n\t\treturn value;\r\n\t};\r\n\r\n\t// 图表绘制方法\r\n\tconst drawPieChart = () => {\r\n\t\tclearChart(pieChart);\r\n\t\tif (!pieChart.value) return;\r\n\r\n\t\tconst percent = Math.min(100, Math.max(0, cleanValue(props.field.value)));\r\n\t\tconst data = [percent, 100 - percent];\r\n\r\n\t\tconst svg = d3\r\n\t\t\t.select(pieChart.value)\r\n\t\t\t.append(\"svg\")\r\n\t\t\t.attr(\"width\", 80)\r\n\t\t\t.attr(\"height\", 80)\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"transform\", \"translate(40,40)\");\r\n\r\n\t\tconst arc = d3.arc().innerRadius(0).outerRadius(35);\r\n\r\n\t\tsvg\r\n\t\t\t.selectAll(\"path\")\r\n\t\t\t.data(d3.pie()(data))\r\n\t\t\t.enter()\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"d\", arc)\r\n\t\t\t.attr(\"fill\", (d, i) => (i === 0 ? \"#4CAF50\" : \"#eee\"));\r\n\r\n\t\tsvg\r\n\t\t\t.append(\"text\")\r\n\t\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t\t.attr(\"dy\", \"0.3em\")\r\n\t\t\t.text(`${percent}%`);\r\n\t};\r\n\r\n\tconst drawBarChart = () => {\r\n\t\tclearChart(barChart);\r\n\t\tif (!barChart.value || processedArray.value.length === 0) return;\r\n\r\n\t\tconst data = processedArray.value.map(item => ({\r\n\t\t\tlabel: item.year || item.raw || \"\",\r\n\t\t\tvalue: item.value\r\n\t\t}));\r\n\r\n\t\tconst svg = d3\r\n\t\t\t.select(barChart.value)\r\n\t\t\t.append(\"svg\")\r\n\t\t\t.attr(\"width\", 150)\r\n\t\t\t.attr(\"height\", 80);\r\n\r\n\t\tconst x = d3\r\n\t\t\t.scaleBand()\r\n\t\t\t.domain(data.map(d => d.label))\r\n\t\t\t.range([10, 140])\r\n\t\t\t.padding(0.2);\r\n\r\n\t\tconst y = d3\r\n\t\t\t.scaleLinear()\r\n\t\t\t.domain([0, d3.max(data, d => d.value)])\r\n\t\t\t.range([60, 10]);\r\n\r\n\t\tsvg\r\n\t\t\t.selectAll(\"rect\")\r\n\t\t\t.data(data)\r\n\t\t\t.enter()\r\n\t\t\t.append(\"rect\")\r\n\t\t\t.attr(\"x\", d => x(d.label))\r\n\t\t\t.attr(\"y\", d => y(d.value))\r\n\t\t\t.attr(\"width\", x.bandwidth())\r\n\t\t\t.attr(\"height\", d => 60 - y(d.value))\r\n\t\t\t.attr(\"fill\", \"#2196F3\");\r\n\r\n\t\tsvg\r\n\t\t\t.selectAll(\"text\")\r\n\t\t\t.data(data)\r\n\t\t\t.enter()\r\n\t\t\t.append(\"text\")\r\n\t\t\t.attr(\"x\", d => x(d.label) + x.bandwidth() / 2)\r\n\t\t\t.attr(\"y\", d => y(d.value) - 5)\r\n\t\t\t.text(d => (props.type === \"percentage\" ? `${d.value}%` : d.value));\r\n\t};\r\n\r\n\tconst drawLineChart = () => {\r\n\t\tclearChart(lineChart);\r\n\t\tif (!lineChart.value || processedArray.value.length < 2) return;\r\n\r\n\t\tconst svg = d3\r\n\t\t\t.select(lineChart.value)\r\n\t\t\t.append(\"svg\")\r\n\t\t\t.attr(\"width\", 200)\r\n\t\t\t.attr(\"height\", 80);\r\n\r\n\t\tconst x = d3\r\n\t\t\t.scaleLinear()\r\n\t\t\t.domain(d3.extent(processedArray.value, d => d.year))\r\n\t\t\t.range([20, 180]);\r\n\r\n\t\tconst y = d3\r\n\t\t\t.scaleLinear()\r\n\t\t\t.domain([0, d3.max(processedArray.value, d => d.value)])\r\n\t\t\t.range([60, 10]);\r\n\r\n\t\tconst line = d3\r\n\t\t\t.line()\r\n\t\t\t.x(d => x(d.year))\r\n\t\t\t.y(d => y(d.value));\r\n\r\n\t\tsvg\r\n\t\t\t.append(\"path\")\r\n\t\t\t.datum(processedArray.value)\r\n\t\t\t.attr(\"d\", line)\r\n\t\t\t.attr(\"stroke\", \"#9C27B0\")\r\n\t\t\t.attr(\"stroke-width\", 2)\r\n\t\t\t.attr(\"fill\", \"none\");\r\n\r\n\t\tsvg\r\n\t\t\t.selectAll(\"circle\")\r\n\t\t\t.data(processedArray.value)\r\n\t\t\t.enter()\r\n\t\t\t.append(\"circle\")\r\n\t\t\t.attr(\"cx\", d => x(d.year))\r\n\t\t\t.attr(\"cy\", d => y(d.value))\r\n\t\t\t.attr(\"r\", 3)\r\n\t\t\t.attr(\"fill\", \"#9C27B0\");\r\n\t};\r\n\r\n\tconst clearChart = element => {\r\n\t\tif (element?.value) d3.select(element.value).selectAll(\"*\").remove();\r\n\t};\r\n\r\n\t// 监听变化\r\n\twatch(\r\n\t\t() => [props.field, props.type],\r\n\t\t() => {\r\n\t\t\tif (!hasData.value) return;\r\n\r\n\t\t\tif (shouldShowPieChart.value) drawPieChart();\r\n\t\t\telse if (shouldShowLineChart.value) drawLineChart();\r\n\t\t\telse if (shouldShowBarChart.value) drawBarChart();\r\n\t\t},\r\n\t\t{ deep: true, immediate: true }\r\n\t);\r\n</script>\r\n\r\n<style scoped>\r\n\t.field-visualization {\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t\tdisplay: flex;\r\n\t\tjustify-content: center;\r\n\t\talign-items: center;\r\n\t}\r\n\r\n\t.text-display {\r\n\t\tpadding: 8px;\r\n\t\ttext-align: center;\r\n\t\tfont-size: 14px;\r\n\t\tline-height: 1.5;\r\n\t}\r\n\r\n\t.pie-chart,\r\n\t.bar-chart,\r\n\t.line-chart {\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t\tmin-height: 80px;\r\n\t}\r\n\r\n\t.no-data {\r\n\t\tcolor: #999;\r\n\t\tfont-style: italic;\r\n\t}\r\n</style>\r\n"],"mappings":";;;EACMA,KAAK,EAAC;AAAqB;;EADjCC,GAAA;EAIkCD,KAAK,EAAC,WAAW;EAACE,GAAG,EAAC;;;EAKpDF,KAAK,EAAC,YAAY;EAClBE,GAAG,EAAC;;;EAKJF,KAAK,EAAC,WAAW;EACjBE,GAAG,EAAC;;;EAGOF,KAAK,EAAC;AAAc;;EAnBnCC,GAAA;EA8BcD,KAAK,EAAC;;;uBA7BnBG,mBAAA,CA8BM,OA9BNC,UA8BM,GA7BWC,MAAA,CAAAC,OAAO,I,cAAvBH,mBAAA,CA2BWI,SAAA;IA7BbN,GAAA;EAAA,IAGGO,mBAAA,WAAc,EACHH,MAAA,CAAAI,kBAAkB,I,cAA7BN,mBAAA,CAAsE,OAAtEO,UAAsE,iCAI1DL,MAAA,CAAAM,mBAAmB,I,cAD/BR,mBAAA,CAGuBI,SAAA;IAV1BN,GAAA;EAAA,IAMGO,mBAAA,aAAgB,EAChBI,mBAAA,CAGuB,OAHvBC,UAGuB,8B,oDAIXR,MAAA,CAAAS,kBAAkB,I,cAD9BX,mBAAA,CAGsBI,SAAA;IAhBzBN,GAAA;EAAA,IAYGO,mBAAA,WAAc,EACdI,mBAAA,CAGsB,OAHtBG,UAGsB,8B,mEAGtBZ,mBAAA,CASMI,SAAA;IA5BTN,GAAA;EAAA,IAkBGO,mBAAA,YAAe,EACfI,mBAAA,CASM,OATNI,UASM,GARWX,MAAA,CAAAY,OAAO,I,kBACtBd,mBAAA,CAEMI,SAAA;IAvBXN,GAAA;EAAA,GAAAiB,WAAA,CAqBkCb,MAAA,CAAAc,cAAc,EArBhD,CAqBkBC,IAAI,EAAEC,KAAK;yBAAxBlB,mBAAA,CAEM;MAFwCF,GAAG,EAAEoB;IAAK,GAAAC,gBAAA,CACpDjB,MAAA,CAAAkB,kBAAkB,CAACH,IAAI;kDAG5BjB,mBAAA,CAEWI,SAAA;IA3BfN,GAAA;EAAA,IAAAuB,gBAAA,CAAAF,gBAAA,CA0BQjB,MAAA,CAAAkB,kBAAkB,CAACE,MAAA,CAAAC,KAAK,kB,+HAI9BvB,mBAAA,CAAqC,OAArCwB,UAAqC,EAAT,KAAG,G","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}