{"ast":null,"code":"import { toDisplayString as _toDisplayString, openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-0c150cb4\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  ref: \"chartContainer\",\n  class: \"sparkline-container\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"no-data-message\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [!$setup.hasEnoughData ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, _toDisplayString($setup.noDataMessage), 1 /* TEXT */)) : _createCommentVNode(\"v-if\", true)], 512 /* NEED_PATCH */);\n}","map":{"version":3,"names":["ref","class","key","_createElementBlock","_hoisted_1","$setup","hasEnoughData","_hoisted_2","_toDisplayString","noDataMessage","_createCommentVNode"],"sources":["D:\\vue_frame\\vue_frame\\wikitable-vue\\client\\src\\components\\compoents_base\\SparklineChart.vue"],"sourcesContent":["<template>\r\n\t<div ref=\"chartContainer\" class=\"sparkline-container\">\r\n\t\t<div v-if=\"!hasEnoughData\" class=\"no-data-message\">\r\n\t\t\t{{ noDataMessage }}\r\n\t\t</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, onMounted, watch, computed, onBeforeUnmount } from \"vue\";\r\n\timport * as d3 from \"d3\";\r\n\r\n\tconst props = defineProps({\r\n\t\tdata: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: () => [],\r\n\t\t\tvalidator: value => Array.isArray(value)\r\n\t\t},\r\n\t\tcompareData: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: null\r\n\t\t},\r\n\t\twidth: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault: 180\r\n\t\t},\r\n\t\theight: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault: 80\r\n\t\t},\r\n\t\tmargin: {\r\n\t\t\ttype: Object,\r\n\t\t\tdefault: () => ({ top: 5, right: 5, bottom: 5, left: 5 })\r\n\t\t},\r\n\t\tlineColor: {\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"#4a90e2\"\r\n\t\t},\r\n\t\tareaColor: {\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"#4a90e2\"\r\n\t\t},\r\n\t\tdotColor: {\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"#4a90e2\"\r\n\t\t},\r\n\t\thighlightColor: {\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"#ef4444\"\r\n\t\t},\r\n\t\tshowTooltip: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: true\r\n\t\t},\r\n\t\tshowDots: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: true\r\n\t\t},\r\n\t\tshowArea: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: true\r\n\t\t},\r\n\t\tshowYearMarkers: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: true\r\n\t\t},\r\n\t\tcurveType: {\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"curveMonotoneX\"\r\n\t\t}\r\n\t});\r\n\r\n\tconst chartContainer = ref(null);\r\n\tconst svg = ref(null);\r\n\tconst tooltip = ref(null);\r\n\tconst isInitialized = ref(false);\r\n\tconst mounted = ref(false);\r\n\r\n\tconst innerWidth = computed(\r\n\t\t() => props.width - props.margin.left - props.margin.right\r\n\t);\r\n\tconst innerHeight = computed(\r\n\t\t() => props.height - props.margin.top - props.margin.bottom\r\n\t);\r\n\r\n\tconst sortedData = computed(() => {\r\n\t\tif (!Array.isArray(props.data)) return [];\r\n\t\treturn [...props.data]\r\n\t\t\t.filter(item => item && !isNaN(item.year) && !isNaN(item.value))\r\n\t\t\t.sort((a, b) => a.year - b.year);\r\n\t});\r\n\r\n\tconst hasEnoughData = computed(() => sortedData.value.length >= 2);\r\n\tconst noDataMessage = computed(() =>\r\n\t\tsortedData.value.length === 0 ? \"无数据\" : \"数据不足，至少需要2个数据点\"\r\n\t);\r\n\r\n\tconst commonYears = computed(() => {\r\n\t\tif (\r\n\t\t\t!props.compareData ||\r\n\t\t\t!Array.isArray(props.compareData) ||\r\n\t\t\t!props.showYearMarkers\r\n\t\t) {\r\n\t\t\treturn new Set();\r\n\t\t}\r\n\r\n\t\tconst currentYears = new Set(sortedData.value.map(d => d.year));\r\n\t\tconst compareYears = new Set(\r\n\t\t\tprops.compareData\r\n\t\t\t\t.filter(item => item && !isNaN(item.year))\r\n\t\t\t\t.map(d => d.year)\r\n\t\t);\r\n\r\n\t\treturn new Set([...currentYears].filter(year => compareYears.has(year)));\r\n\t});\r\n\r\n\tconst xScale = computed(() => {\r\n\t\tif (!hasEnoughData.value) return null;\r\n\r\n\t\tconst years = sortedData.value.map(d => d.year);\r\n\t\treturn d3\r\n\t\t\t.scaleLinear()\r\n\t\t\t.domain(d3.extent(years))\r\n\t\t\t.range([0, innerWidth.value]);\r\n\t});\r\n\r\n\tconst yScale = computed(() => {\r\n\t\tif (!hasEnoughData.value) return null;\r\n\r\n\t\tconst values = sortedData.value.map(d => d.value);\r\n\t\tconst minValue = d3.min(values);\r\n\t\tconst maxValue = d3.max(values);\r\n\t\tconst padding = (maxValue - minValue) * 0.1;\r\n\r\n\t\treturn d3\r\n\t\t\t.scaleLinear()\r\n\t\t\t.domain([minValue - padding, maxValue + padding])\r\n\t\t\t.range([innerHeight.value, 0]);\r\n\t});\r\n\r\n\tconst lineGenerator = computed(() => {\r\n\t\tif (!hasEnoughData.value || !xScale.value || !yScale.value) {\r\n\t\t\treturn () => \"\";\r\n\t\t}\r\n\r\n\t\treturn d3\r\n\t\t\t.line()\r\n\t\t\t.x(d => xScale.value(d.year))\r\n\t\t\t.y(d => yScale.value(d.value))\r\n\t\t\t.curve(d3[props.curveType]);\r\n\t});\r\n\r\n\tconst areaGenerator = computed(() => {\r\n\t\tif (\r\n\t\t\t!hasEnoughData.value ||\r\n\t\t\t!xScale.value ||\r\n\t\t\t!yScale.value ||\r\n\t\t\t!props.showArea\r\n\t\t) {\r\n\t\t\treturn () => \"\";\r\n\t\t}\r\n\r\n\t\treturn d3\r\n\t\t\t.area()\r\n\t\t\t.x(d => xScale.value(d.year))\r\n\t\t\t.y0(innerHeight.value)\r\n\t\t\t.y1(d => yScale.value(d.value))\r\n\t\t\t.curve(d3[props.curveType]);\r\n\t});\r\n\r\n\tconst formatValue = value => {\r\n\t\tif (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;\r\n\t\tif (value >= 1000) return `$${(value / 1000).toFixed(1)}K`;\r\n\t\treturn value.toLocaleString();\r\n\t};\r\n\r\n\tconst getYearBands = () => {\r\n\t\tconst years = Array.from(commonYears.value).sort((a, b) => a - b);\r\n\t\tif (years.length === 0) return [];\r\n\r\n\t\tconst bands = [];\r\n\t\tlet currentBand = { start: years[0], end: years[0] };\r\n\r\n\t\tfor (let i = 1; i < years.length; i++) {\r\n\t\t\tif (years[i] === currentBand.end + 1) {\r\n\t\t\t\tcurrentBand.end = years[i];\r\n\t\t\t} else {\r\n\t\t\t\tbands.push({ ...currentBand });\r\n\t\t\t\tcurrentBand = { start: years[i], end: years[i] };\r\n\t\t\t}\r\n\t\t}\r\n\t\tbands.push(currentBand);\r\n\r\n\t\treturn bands;\r\n\t};\r\n\r\n\tconst destroyChart = () => {\r\n\t\ttry {\r\n\t\t\tif (chartContainer.value) {\r\n\t\t\t\t// 使用原生DOM操作确保完全清理\r\n\t\t\t\tchartContainer.value.innerHTML = \"\";\r\n\t\t\t}\r\n\t\t\tsvg.value = null;\r\n\t\t\ttooltip.value = null;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"销毁图表时出错:\", error);\r\n\t\t}\r\n\t};\r\n\r\n\tconst initChart = () => {\r\n\t\tif (!mounted.value || !chartContainer.value) return;\r\n\r\n\t\tdestroyChart();\r\n\r\n\t\tif (!hasEnoughData.value) {\r\n\t\t\tisInitialized.value = false;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tsvg.value = d3\r\n\t\t\t\t.select(chartContainer.value)\r\n\t\t\t\t.append(\"svg\")\r\n\t\t\t\t.attr(\"width\", props.width)\r\n\t\t\t\t.attr(\"height\", props.height)\r\n\t\t\t\t.attr(\"viewBox\", `0 0 ${props.width} ${props.height}`)\r\n\t\t\t\t.attr(\"preserveAspectRatio\", \"xMidYMid meet\");\r\n\r\n\t\t\t// ...保持原有的图表绘制逻辑...\r\n\r\n\t\t\tisInitialized.value = true;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"图表初始化错误:\", error);\r\n\t\t\tdestroyChart();\r\n\t\t}\r\n\t};\r\n\r\n\tconst addTooltip = chart => {\r\n\t\t// ...保持原有的工具提示逻辑...\r\n\t};\r\n\r\n\tonMounted(() => {\r\n\t\tmounted.value = true;\r\n\t\t// 使用requestAnimationFrame确保DOM就绪\r\n\t\trequestAnimationFrame(() => {\r\n\t\t\tinitChart();\r\n\t\t});\r\n\t});\r\n\r\n\tonBeforeUnmount(() => {\r\n\t\tmounted.value = false;\r\n\t\tdestroyChart();\r\n\t});\r\n\r\n\twatch(\r\n\t\t() => [\r\n\t\t\tprops.data,\r\n\t\t\tprops.compareData,\r\n\t\t\tprops.width,\r\n\t\t\tprops.height,\r\n\t\t\tprops.margin,\r\n\t\t\tprops.lineColor,\r\n\t\t\tprops.areaColor,\r\n\t\t\tprops.dotColor,\r\n\t\t\tprops.highlightColor,\r\n\t\t\tprops.showTooltip,\r\n\t\t\tprops.showDots,\r\n\t\t\tprops.showArea,\r\n\t\t\tprops.showYearMarkers,\r\n\t\t\tprops.curveType,\r\n\t\t\thasEnoughData.value\r\n\t\t],\r\n\t\t() => {\r\n\t\t\tif (mounted.value) {\r\n\t\t\t\trequestAnimationFrame(initChart);\r\n\t\t\t}\r\n\t\t},\r\n\t\t{ deep: true }\r\n\t);\r\n</script>\r\n\r\n<style scoped>\r\n\t.sparkline-container {\r\n\t\tposition: relative;\r\n\t\tdisplay: inline-block;\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t\tmin-height: 60px; /* 确保最小高度 */\r\n\t\tfont-family: system-ui, -apple-system, sans-serif;\r\n\t}\r\n\r\n\t.no-data-message {\r\n\t\tposition: absolute;\r\n\t\ttop: 50%;\r\n\t\tleft: 50%;\r\n\t\ttransform: translate(-50%, -50%);\r\n\t\tcolor: #94a3b8;\r\n\t\tfont-size: 12px;\r\n\t\ttext-align: center;\r\n\t\twidth: 100%;\r\n\t\tpadding: 0 10px;\r\n\t\tbox-sizing: border-box;\r\n\t\tword-break: keep-all; /* 防止文字换行 */\r\n\t\twhite-space: nowrap; /* 确保文字水平排列 */\r\n\t\tpointer-events: none;\r\n\t}\r\n\r\n\t/* 保持其他样式不变 */\r\n</style>\r\n"],"mappings":";;;EACMA,GAAG,EAAC,gBAAgB;EAACC,KAAK,EAAC;;;EADjCC,GAAA;EAE6BD,KAAK,EAAC;;;uBADlCE,mBAAA,CAIM,OAJNC,UAIM,G,CAHOC,MAAA,CAAAC,aAAa,I,cAAzBH,mBAAA,CAEM,OAFNI,UAEM,EAAAC,gBAAA,CADFH,MAAA,CAAAI,aAAa,oBAHnBC,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}