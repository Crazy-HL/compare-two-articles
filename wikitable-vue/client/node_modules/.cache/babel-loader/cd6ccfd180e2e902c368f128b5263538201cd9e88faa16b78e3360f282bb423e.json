{"ast":null,"code":"import { openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-3d881255\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  ref: \"chartContainer\",\n  class: \"pie-chart-container\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"no-data\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [!$setup.hasValidData ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, \"-\")) : _createCommentVNode(\"v-if\", true)], 512 /* NEED_PATCH */);\n}","map":{"version":3,"names":["ref","class","key","_createElementBlock","_hoisted_1","$setup","hasValidData","_hoisted_2","_createCommentVNode"],"sources":["D:\\vue_frame\\vue_frame\\wikitable-vue\\client\\src\\components\\compoents_base\\charts\\PieChart.vue"],"sourcesContent":["<template>\r\n\t<div ref=\"chartContainer\" class=\"pie-chart-container\">\r\n\t\t<div v-if=\"!hasValidData\" class=\"no-data\">-</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, computed, onMounted, watch } from \"vue\";\r\n\timport * as d3 from \"d3\";\r\n\r\n\tconst props = defineProps({\r\n\t\tdata: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: () => [],\r\n\t\t\tvalidator: value => value.every(item => \"name\" in item && \"value\" in item)\r\n\t\t},\r\n\t\tshowLegend: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false\r\n\t\t},\r\n\t\tisSingleValue: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false\r\n\t\t}\r\n\t});\r\n\r\n\tconst emit = defineEmits([\"itemClick\", \"dataOutput\"]);\r\n\r\n\tconst chartContainer = ref(null);\r\n\tconst colors = [\r\n\t\t\"#3498db\",\r\n\t\t\"#e74c3c\",\r\n\t\t\"#2ecc71\",\r\n\t\t\"#f39c12\",\r\n\t\t\"#9b59b6\",\r\n\t\t\"#1abc9c\"\r\n\t];\r\n\tconst remainderColor = \"#f0f0f0\";\r\n\r\n\tconst isYearEntry = value => {\r\n\t\tif (typeof value !== \"string\") return false;\r\n\t\tconst trimmedValue = value.trim();\r\n\t\treturn (\r\n\t\t\t/^(\\()?\\d{4}(\\))?\\s*:?/.test(trimmedValue) ||\r\n\t\t\t/^\\(?FY\\s*\\d{4}\\)?\\s*:?/i.test(trimmedValue) ||\r\n\t\t\t/^(\\()?\\d{4}\\s*[-–]\\s*\\d{2,4}(\\))?\\s*:?/.test(trimmedValue) ||\r\n\t\t\t/^(Year|Yr|Annual)\\s*\\d{4}/i.test(trimmedValue)\r\n\t\t);\r\n\t};\r\n\r\n\tconst filteredData = computed(() => {\r\n\t\treturn props.data.filter(item => {\r\n\t\t\tconst name = String(item.name || \"\");\r\n\t\t\tconst value = String(item.value || \"\");\r\n\t\t\treturn !isYearEntry(name) && !isYearEntry(value);\r\n\t\t});\r\n\t});\r\n\r\n\tconst hasValidData = computed(() => filteredData.value.length > 0);\r\n\r\n\tconst processedData = computed(() => {\r\n\t\tif (!hasValidData.value) return [];\r\n\r\n\t\t// 如果是单值饼图，添加剩余部分\r\n\t\tif (props.isSingleValue) {\r\n\t\t\tconst mainValue = Math.min(\r\n\t\t\t\t100,\r\n\t\t\t\tMath.max(0, Number(filteredData.value[0].value) || 0)\r\n\t\t\t);\r\n\t\t\treturn [\r\n\t\t\t\t{ ...filteredData.value[0], value: mainValue, isMain: true, index: 0 },\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"剩余\",\r\n\t\t\t\t\tvalue: Math.max(0, 100 - mainValue),\r\n\t\t\t\t\tisRemainder: true,\r\n\t\t\t\t\tindex: 1\r\n\t\t\t\t}\r\n\t\t\t];\r\n\t\t}\r\n\r\n\t\t// 多值饼图直接返回处理后的数据\r\n\t\treturn filteredData.value.map((item, index) => ({\r\n\t\t\t...item,\r\n\t\t\tvalue: Math.min(100, Math.max(0, Number(item.value) || 0)),\r\n\t\t\tindex\r\n\t\t}));\r\n\t});\r\n\r\n\tlet svg, arc, pie, tooltip;\r\n\r\n\tconst initChart = () => {\r\n\t\tif (!chartContainer.value || !hasValidData.value) return;\r\n\r\n\t\td3.select(chartContainer.value).selectAll(\"*\").remove();\r\n\r\n\t\tconst container = d3.select(chartContainer.value);\r\n\t\tconst width = chartContainer.value.clientWidth;\r\n\t\tconst height = chartContainer.value.clientHeight;\r\n\t\tconst radius = (Math.min(width, height) / 2) * 0.7;\r\n\r\n\t\tsvg = container\r\n\t\t\t.append(\"svg\")\r\n\t\t\t.attr(\"width\", \"100%\")\r\n\t\t\t.attr(\"height\", \"100%\")\r\n\t\t\t.attr(\"viewBox\", `0 0 ${width} ${height}`);\r\n\r\n\t\tconst pieGroup = svg\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"transform\", `translate(${width / 2}, ${height / 2.5})`);\r\n\r\n\t\tpie = d3\r\n\t\t\t.pie()\r\n\t\t\t.value(d => d.value)\r\n\t\t\t.sort(null);\r\n\r\n\t\tarc = d3.arc().innerRadius(0).outerRadius(radius).cornerRadius(4);\r\n\r\n\t\ttooltip = container\r\n\t\t\t.append(\"div\")\r\n\t\t\t.attr(\"class\", \"chart-tooltip\")\r\n\t\t\t.style(\"opacity\", 0);\r\n\r\n\t\tconst arcs = pieGroup\r\n\t\t\t.selectAll(\".arc\")\r\n\t\t\t.data(pie(processedData.value))\r\n\t\t\t.enter()\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"class\", \"arc\");\r\n\r\n\t\tarcs\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"d\", arc)\r\n\t\t\t.attr(\"fill\", d =>\r\n\t\t\t\td.data.isRemainder\r\n\t\t\t\t\t? remainderColor\r\n\t\t\t\t\t: colors[d.data.index % colors.length]\r\n\t\t\t)\r\n\t\t\t.style(\"opacity\", d => (d.data.isRemainder ? 0.6 : 0.8))\r\n\t\t\t.style(\"stroke\", \"#fff\")\r\n\t\t\t.style(\"stroke-width\", 1.5)\r\n\t\t\t.style(\"transition\", \"opacity 0.2s\")\r\n\t\t\t.on(\"mouseover\", function (event, d) {\r\n\t\t\t\tif (d.data.isRemainder) return;\r\n\r\n\t\t\t\td3.select(this).transition().duration(200).style(\"opacity\", 1);\r\n\t\t\t\ttooltip.transition().duration(200).style(\"opacity\", 1);\r\n\t\t\t\ttooltip\r\n\t\t\t\t\t.html(\r\n\t\t\t\t\t\t`\r\n          <div class=\"tooltip-title\">${d.data.name}</div>\r\n          <div class=\"tooltip-value\">${d.data.value.toFixed(1)}%</div>\r\n        `\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.style(\"left\", event.pageX + 15 + \"px\")\r\n\t\t\t\t\t.style(\"top\", event.pageY - 30 + \"px\");\r\n\t\t\t})\r\n\t\t\t.on(\"mouseout\", function () {\r\n\t\t\t\td3.select(this).transition().duration(200).style(\"opacity\", 0.8);\r\n\t\t\t\ttooltip.transition().duration(200).style(\"opacity\", 0);\r\n\t\t\t})\r\n\t\t\t.on(\"click\", (event, d) => {\r\n\t\t\t\tif (d.data.isRemainder) return;\r\n\t\t\t\temit(\"itemClick\", d.data);\r\n\t\t\t});\r\n\r\n\t\t// 单值饼图显示中心数值\r\n\t\tif (props.isSingleValue) {\r\n\t\t\tpieGroup\r\n\t\t\t\t.append(\"text\")\r\n\t\t\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t\t\t.attr(\"dy\", \".3em\")\r\n\t\t\t\t.text(`${filteredData.value[0].value.toFixed(1)}%`)\r\n\t\t\t\t.style(\"font-size\", \"16px\")\r\n\t\t\t\t.style(\"fill\", \"#333\")\r\n\t\t\t\t.style(\"font-weight\", \"500\");\r\n\t\t}\r\n\r\n\t\t// 多值饼图显示图例\r\n\t\tif (props.showLegend && !props.isSingleValue) {\r\n\t\t\tconst legendData = processedData.value.filter(d => !d.isRemainder);\r\n\t\t\tconst legendGroup = svg.append(\"g\").attr(\"class\", \"legend\");\r\n\r\n\t\t\tconst legendItemHeight = 20;\r\n\t\t\tconst legendSpacing = 6;\r\n\t\t\tconst legendPadding = 10;\r\n\r\n\t\t\tlegendData.forEach((d, i) => {\r\n\t\t\t\tconst g = legendGroup\r\n\t\t\t\t\t.append(\"g\")\r\n\t\t\t\t\t.attr(\"class\", \"legend-item\")\r\n\t\t\t\t\t.attr(\r\n\t\t\t\t\t\t\"transform\",\r\n\t\t\t\t\t\t`translate(${width - 150}, ${\r\n\t\t\t\t\t\t\tlegendPadding + i * (legendItemHeight + legendSpacing)\r\n\t\t\t\t\t\t})`\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.style(\"cursor\", \"pointer\")\r\n\t\t\t\t\t.on(\"click\", () => emit(\"itemClick\", d));\r\n\r\n\t\t\t\tg.append(\"rect\")\r\n\t\t\t\t\t.attr(\"width\", 14)\r\n\t\t\t\t\t.attr(\"height\", 14)\r\n\t\t\t\t\t.attr(\"rx\", 2)\r\n\t\t\t\t\t.attr(\"ry\", 2)\r\n\t\t\t\t\t.attr(\"fill\", colors[d.index % colors.length]);\r\n\r\n\t\t\t\tg.append(\"text\")\r\n\t\t\t\t\t.attr(\"x\", 120)\r\n\t\t\t\t\t.attr(\"y\", 111)\r\n\t\t\t\t\t.text(`${d.name} (${d.value}%)`)\r\n\t\t\t\t\t.style(\"font-size\", \"12px\")\r\n\t\t\t\t\t.style(\"fill\", \"#333\")\r\n\t\t\t\t\t.style(\"font-family\", \"Arial, sans-serif\");\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tonMounted(() => {\r\n\t\tinitChart();\r\n\t\twindow.addEventListener(\"resize\", initChart);\r\n\t});\r\n\r\n\twatch(() => [props.data, props.showLegend, props.isSingleValue], initChart, {\r\n\t\tdeep: true\r\n\t});\r\n</script>\r\n\r\n<style scoped>\r\n\t.pie-chart-container {\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t\tmin-height: 260px;\r\n\t\tposition: relative;\r\n\t\tbackground: #fff;\r\n\t\tborder-radius: 8px;\r\n\t\tbox-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\r\n\t\ttransition: box-shadow 0.3s ease;\r\n\t}\r\n\r\n\t.pie-chart-container:hover {\r\n\t\tbox-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n\t}\r\n\r\n\t.no-data {\r\n\t\tposition: absolute;\r\n\t\ttop: 50%;\r\n\t\tleft: 50%;\r\n\t\ttransform: translate(-50%, -50%);\r\n\t\tcolor: #999;\r\n\t\tfont-size: 14px;\r\n\t\tfont-family: Arial, sans-serif;\r\n\t}\r\n\r\n\t.chart-tooltip {\r\n\t\tposition: absolute;\r\n\t\tpadding: 10px 12px;\r\n\t\tbackground: rgba(0, 0, 0, 0.85);\r\n\t\tcolor: white;\r\n\t\tborder-radius: 6px;\r\n\t\tfont-size: 13px;\r\n\t\tfont-family: Arial, sans-serif;\r\n\t\tpointer-events: none;\r\n\t\tz-index: 10;\r\n\t\ttransition: all 0.2s;\r\n\t\tbox-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);\r\n\t\tmax-width: 200px;\r\n\t\tline-height: 1.5;\r\n\t}\r\n\r\n\t.tooltip-title {\r\n\t\tfont-weight: 600;\r\n\t\tmargin-bottom: 4px;\r\n\t\tcolor: #fff;\r\n\t}\r\n\r\n\t.tooltip-value {\r\n\t\tfont-weight: 500;\r\n\t\tcolor: #f0f0f0;\r\n\t}\r\n</style>\r\n"],"mappings":";;;EACMA,GAAG,EAAC,gBAAgB;EAACC,KAAK,EAAC;;;EADjCC,GAAA;EAE4BD,KAAK,EAAC;;;uBADjCE,mBAAA,CAEM,OAFNC,UAEM,G,CADOC,MAAA,CAAAC,YAAY,I,cAAxBH,mBAAA,CAAiD,OAAjDI,UAAiD,EAAP,GAAC,KAF7CC,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}