{"ast":null,"code":"import { openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, renderList as _renderList, Fragment as _Fragment, normalizeStyle as _normalizeStyle, createElementVNode as _createElementVNode, toDisplayString as _toDisplayString, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-201e19b8\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  ref: \"chartContainer\",\n  class: \"full-chart\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"no-data-message\"\n};\nconst _hoisted_3 = {\n  key: 1,\n  class: \"team-legend\"\n};\nconst _hoisted_4 = {\n  class: \"legend-text\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [!$setup.hasData ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, \"无数据可显示\")) : _createCommentVNode(\"v-if\", true), $setup.teamLegend.length > 0 ? (_openBlock(), _createElementBlock(\"div\", _hoisted_3, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.teamLegend, item => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: item.team,\n      class: \"legend-item\"\n    }, [_createElementVNode(\"span\", {\n      class: \"legend-color\",\n      style: _normalizeStyle({\n        backgroundColor: item.color\n      })\n    }, null, 4 /* STYLE */), _createElementVNode(\"span\", _hoisted_4, _toDisplayString(item.team), 1 /* TEXT */)]);\n  }), 128 /* KEYED_FRAGMENT */))])) : _createCommentVNode(\"v-if\", true)], 512 /* NEED_PATCH */);\n}","map":{"version":3,"names":["ref","class","key","_createElementBlock","_hoisted_1","$setup","hasData","_hoisted_2","_createCommentVNode","teamLegend","length","_hoisted_3","_Fragment","_renderList","item","team","_createElementVNode","style","_normalizeStyle","backgroundColor","color","_hoisted_4","_toDisplayString"],"sources":["D:\\vue_frame\\vue_frame\\wikitable-vue\\client\\src\\components\\compoents_base\\FullChart.vue"],"sourcesContent":["<template>\r\n\t<div ref=\"chartContainer\" class=\"full-chart\">\r\n\t\t<div v-if=\"!hasData\" class=\"no-data-message\">无数据可显示</div>\r\n\t\t<div v-if=\"teamLegend.length > 0\" class=\"team-legend\">\r\n\t\t\t<div v-for=\"item in teamLegend\" :key=\"item.team\" class=\"legend-item\">\r\n\t\t\t\t<span\r\n\t\t\t\t\tclass=\"legend-color\"\r\n\t\t\t\t\t:style=\"{ backgroundColor: item.color }\"></span>\r\n\t\t\t\t<span class=\"legend-text\">{{ item.team }}</span>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, computed, onMounted, watch } from \"vue\";\r\n\timport * as d3 from \"d3\";\r\n\r\n\tconst props = defineProps({\r\n\t\tdata: {\r\n\t\t\ttype: Object,\r\n\t\t\tdefault: () => ({\r\n\t\t\t\ttype: \"line\",\r\n\t\t\t\tdata: []\r\n\t\t\t}),\r\n\t\t\tvalidator: value => {\r\n\t\t\t\treturn (\r\n\t\t\t\t\tvalue &&\r\n\t\t\t\t\t[\"line\", \"bar\"].includes(value.type) &&\r\n\t\t\t\t\tArray.isArray(value.data)\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t},\r\n\t\tcompareData: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: () => [],\r\n\t\t\tvalidator: value => Array.isArray(value)\r\n\t\t},\r\n\t\ttitle: {\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"\"\r\n\t\t},\r\n\t\tside: {\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"left\",\r\n\t\t\tvalidator: value => [\"left\", \"right\"].includes(value)\r\n\t\t},\r\n\t\tteamColors: {\r\n\t\t\ttype: Object,\r\n\t\t\tdefault: () => ({})\r\n\t\t}\r\n\t});\r\n\r\n\tconst chartContainer = ref(null);\r\n\tconst teamLegend = ref([]);\r\n\tconst color = computed(() => (props.side === \"left\" ? \"#4a90e2\" : \"#ef4444\"));\r\n\tconst highlightColor = \"#FFD700\";\r\n\tconst hasData = computed(() => {\r\n\t\treturn (\r\n\t\t\tprops.data?.data?.length > 0 &&\r\n\t\t\tprops.data.data.every(\r\n\t\t\t\titem => item && !isNaN(item.year) && !isNaN(item.value)\r\n\t\t\t)\r\n\t\t);\r\n\t});\r\n\r\n\t// 清理团队名称中的特殊字符\r\n\tconst sanitizeTeamName = team => {\r\n\t\treturn team.replace(/[^a-zA-Z0-9]/g, \"-\");\r\n\t};\r\n\r\n\tconst drawChart = () => {\r\n\t\tif (!chartContainer.value || !hasData.value) {\r\n\t\t\td3.select(chartContainer.value).selectAll(\"*\").remove();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\td3.select(chartContainer.value).selectAll(\"*\").remove();\r\n\t\t\tteamLegend.value = [];\r\n\r\n\t\t\tconst margin = { top: 30, right: 30, bottom: 70, left: 50 };\r\n\t\t\tconst width = 800 - margin.left - margin.right;\r\n\t\t\tconst height = 500 - margin.top - margin.bottom;\r\n\r\n\t\t\tconst svg = d3\r\n\t\t\t\t.select(chartContainer.value)\r\n\t\t\t\t.append(\"svg\")\r\n\t\t\t\t.attr(\"width\", width + margin.left + margin.right)\r\n\t\t\t\t.attr(\"height\", height + margin.top + margin.bottom + 40)\r\n\t\t\t\t.append(\"g\")\r\n\t\t\t\t.attr(\"transform\", `translate(${margin.left},${margin.top})`);\r\n\r\n\t\t\tconst processedData = processTeamData(props.data.data);\r\n\t\t\tif (processedData.length === 0) return;\r\n\r\n\t\t\tconst x =\r\n\t\t\t\tprops.data.type === \"bar\"\r\n\t\t\t\t\t? d3\r\n\t\t\t\t\t\t\t.scaleBand()\r\n\t\t\t\t\t\t\t.domain(processedData.map(d => d.year.toString()))\r\n\t\t\t\t\t\t\t.range([0, width])\r\n\t\t\t\t\t\t\t.padding(0.2)\r\n\t\t\t\t\t: d3\r\n\t\t\t\t\t\t\t.scaleLinear()\r\n\t\t\t\t\t\t\t.domain(d3.extent(processedData, d => d.year))\r\n\t\t\t\t\t\t\t.range([0, width]);\r\n\r\n\t\t\tconst y = d3\r\n\t\t\t\t.scaleLinear()\r\n\t\t\t\t.domain([0, d3.max(processedData, d => d.value) * 1.1])\r\n\t\t\t\t.range([height, 0]);\r\n\r\n\t\t\t// 绘制网格线\r\n\t\t\tsvg\r\n\t\t\t\t.append(\"g\")\r\n\t\t\t\t.attr(\"class\", \"grid\")\r\n\t\t\t\t.call(d3.axisLeft(y).tickSize(-width).tickFormat(\"\"))\r\n\t\t\t\t.selectAll(\"line\")\r\n\t\t\t\t.attr(\"stroke\", \"#e2e8f0\")\r\n\t\t\t\t.attr(\"stroke-dasharray\", \"2,2\");\r\n\r\n\t\t\t// 绘制坐标轴\r\n\t\t\tsvg\r\n\t\t\t\t.append(\"g\")\r\n\t\t\t\t.attr(\"transform\", `translate(0,${height})`)\r\n\t\t\t\t.call(\r\n\t\t\t\t\tprops.data.type === \"bar\"\r\n\t\t\t\t\t\t? d3.axisBottom(x)\r\n\t\t\t\t\t\t: d3.axisBottom(x).tickFormat(d3.format(\"d\"))\r\n\t\t\t\t);\r\n\t\t\tsvg.append(\"g\").call(d3.axisLeft(y));\r\n\r\n\t\t\t// 添加标签\r\n\t\t\tsvg\r\n\t\t\t\t.append(\"text\")\r\n\t\t\t\t.attr(\r\n\t\t\t\t\t\"transform\",\r\n\t\t\t\t\t`translate(${width / 2},${height + margin.top + 10})`\r\n\t\t\t\t)\r\n\t\t\t\t.style(\"text-anchor\", \"middle\")\r\n\t\t\t\t.text(\"年份\");\r\n\t\t\tsvg\r\n\t\t\t\t.append(\"text\")\r\n\t\t\t\t.attr(\"transform\", \"rotate(-90)\")\r\n\t\t\t\t.attr(\"y\", 0 - margin.left)\r\n\t\t\t\t.attr(\"x\", 0 - height / 2)\r\n\t\t\t\t.attr(\"dy\", \"1em\")\r\n\t\t\t\t.style(\"text-anchor\", \"middle\")\r\n\t\t\t\t.text(\"数值\");\r\n\t\t\tsvg\r\n\t\t\t\t.append(\"text\")\r\n\t\t\t\t.attr(\"x\", width / 2)\r\n\t\t\t\t.attr(\"y\", 0 - margin.top / 2)\r\n\t\t\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t\t\t.style(\"font-size\", \"16px\")\r\n\t\t\t\t.style(\"font-weight\", \"bold\")\r\n\t\t\t\t.text(props.title);\r\n\r\n\t\t\tif (props.data.type === \"bar\") {\r\n\t\t\t\tdrawTeamBarChart(svg, processedData, x, y, width, height);\r\n\t\t\t} else {\r\n\t\t\t\tdrawTeamLineChart(svg, processedData, x, y);\r\n\t\t\t}\r\n\r\n\t\t\t// 添加团队图例\r\n\t\t\tif (teamLegend.value.length > 0) {\r\n\t\t\t\tconst legend = svg\r\n\t\t\t\t\t.append(\"g\")\r\n\t\t\t\t\t.attr(\"class\", \"legend\")\r\n\t\t\t\t\t.attr(\"transform\", `translate(0,${height + 40})`);\r\n\r\n\t\t\t\tlegend\r\n\t\t\t\t\t.selectAll(\".legend-item\")\r\n\t\t\t\t\t.data(teamLegend.value)\r\n\t\t\t\t\t.enter()\r\n\t\t\t\t\t.append(\"g\")\r\n\t\t\t\t\t.attr(\"class\", \"legend-item\")\r\n\t\t\t\t\t.attr(\"transform\", (d, i) => `translate(${i * 150}, 0)`)\r\n\t\t\t\t\t.each(function (d) {\r\n\t\t\t\t\t\td3.select(this)\r\n\t\t\t\t\t\t\t.append(\"rect\")\r\n\t\t\t\t\t\t\t.attr(\"width\", 12)\r\n\t\t\t\t\t\t\t.attr(\"height\", 12)\r\n\t\t\t\t\t\t\t.attr(\"fill\", d.color);\r\n\r\n\t\t\t\t\t\td3.select(this)\r\n\t\t\t\t\t\t\t.append(\"text\")\r\n\t\t\t\t\t\t\t.attr(\"x\", 16)\r\n\t\t\t\t\t\t\t.attr(\"y\", 9)\r\n\t\t\t\t\t\t\t.attr(\"dy\", \"0.35em\")\r\n\t\t\t\t\t\t\t.style(\"font-size\", \"10px\")\r\n\t\t\t\t\t\t\t.text(d.team);\r\n\t\t\t\t\t});\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"图表渲染错误:\", error);\r\n\t\t}\r\n\t};\r\n\r\n\tconst processTeamData = data => {\r\n\t\tconst teamMap = new Map();\r\n\t\tconst result = [];\r\n\r\n\t\tdata.forEach(item => {\r\n\t\t\tif (!item || !item.year || isNaN(item.value)) return;\r\n\r\n\t\t\tconst key = `${item.year}-${item.team || \"Unknown\"}`;\r\n\t\t\tif (!teamMap.has(key)) {\r\n\t\t\t\tteamMap.set(key, true);\r\n\t\t\t\tresult.push({\r\n\t\t\t\t\t...item,\r\n\t\t\t\t\tdisplayYear: item.team\r\n\t\t\t\t\t\t? `${item.year} (${item.team})`\r\n\t\t\t\t\t\t: item.year.toString()\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\titem.team &&\r\n\t\t\t\t\tprops.teamColors[item.team] &&\r\n\t\t\t\t\t!teamLegend.value.some(t => t.team === item.team)\r\n\t\t\t\t) {\r\n\t\t\t\t\tteamLegend.value.push({\r\n\t\t\t\t\t\tteam: item.team,\r\n\t\t\t\t\t\tcolor: props.teamColors[item.team]\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\treturn result.sort((a, b) => a.year - b.year);\r\n\t};\r\n\r\n\tconst drawTeamBarChart = (svg, data, x, y, width, height) => {\r\n\t\tconst teamGroups = d3.group(data, d => d.team);\r\n\t\tconst xSubgroup = d3\r\n\t\t\t.scaleBand()\r\n\t\t\t.domain([...teamGroups.keys()])\r\n\t\t\t.range([0, x.bandwidth()])\r\n\t\t\t.padding(0.05);\r\n\r\n\t\tsvg\r\n\t\t\t.append(\"g\")\r\n\t\t\t.selectAll(\"g\")\r\n\t\t\t.data(d3.group(data, d => d.year))\r\n\t\t\t.enter()\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"transform\", d => `translate(${x(d[0])},0)`)\r\n\t\t\t.selectAll(\"rect\")\r\n\t\t\t.data(d => {\r\n\t\t\t\tconst yearData = d[1];\r\n\t\t\t\treturn [...teamGroups.keys()].map(team => {\r\n\t\t\t\t\tconst teamData = yearData.find(item => item.team === team);\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tyear: d[0],\r\n\t\t\t\t\t\tteam,\r\n\t\t\t\t\t\tvalue: teamData?.value || 0,\r\n\t\t\t\t\t\tcolor: props.teamColors[team] || \"#999\"\r\n\t\t\t\t\t};\r\n\t\t\t\t});\r\n\t\t\t})\r\n\t\t\t.enter()\r\n\t\t\t.append(\"rect\")\r\n\t\t\t.attr(\"x\", d => xSubgroup(d.team))\r\n\t\t\t.attr(\"y\", d => y(d.value))\r\n\t\t\t.attr(\"width\", xSubgroup.bandwidth())\r\n\t\t\t.attr(\"height\", d => height - y(d.value))\r\n\t\t\t.attr(\"fill\", d => d.color)\r\n\t\t\t.attr(\"rx\", 2)\r\n\t\t\t.attr(\"ry\", 2);\r\n\t};\r\n\r\n\tconst drawTeamLineChart = (svg, data, x, y) => {\r\n\t\tconst teamGroups = d3.group(data, d => d.team);\r\n\r\n\t\tteamGroups.forEach((teamData, team) => {\r\n\t\t\tconst safeTeamName = sanitizeTeamName(team);\r\n\t\t\tconst line = d3\r\n\t\t\t\t.line()\r\n\t\t\t\t.x(d => x(d.year))\r\n\t\t\t\t.y(d => y(d.value))\r\n\t\t\t\t.curve(d3.curveMonotoneX);\r\n\r\n\t\t\tsvg\r\n\t\t\t\t.append(\"path\")\r\n\t\t\t\t.datum(teamData)\r\n\t\t\t\t.attr(\"fill\", \"none\")\r\n\t\t\t\t.attr(\"stroke\", props.teamColors[team] || \"#999\")\r\n\t\t\t\t.attr(\"stroke-width\", 3)\r\n\t\t\t\t.attr(\"d\", line);\r\n\r\n\t\t\tsvg\r\n\t\t\t\t.selectAll(`.dot-${safeTeamName}`)\r\n\t\t\t\t.data(teamData)\r\n\t\t\t\t.enter()\r\n\t\t\t\t.append(\"circle\")\r\n\t\t\t\t.attr(\"class\", `dot-${safeTeamName}`)\r\n\t\t\t\t.attr(\"cx\", d => x(d.year))\r\n\t\t\t\t.attr(\"cy\", d => y(d.value))\r\n\t\t\t\t.attr(\"r\", 6)\r\n\t\t\t\t.attr(\"fill\", props.teamColors[team] || \"#999\")\r\n\t\t\t\t.attr(\"stroke\", \"white\")\r\n\t\t\t\t.attr(\"stroke-width\", 2);\r\n\t\t});\r\n\r\n\t\tif (props.compareData && props.compareData.length > 0) {\r\n\t\t\tconst commonYears = getCommonYears(data, props.compareData);\r\n\t\t\tcommonYears.forEach(year => {\r\n\t\t\t\tconst points = data.filter(d => d.year === year);\r\n\t\t\t\tpoints.forEach(point => {\r\n\t\t\t\t\tsvg\r\n\t\t\t\t\t\t.append(\"circle\")\r\n\t\t\t\t\t\t.attr(\"cx\", x(point.year))\r\n\t\t\t\t\t\t.attr(\"cy\", y(point.value))\r\n\t\t\t\t\t\t.attr(\"r\", 8)\r\n\t\t\t\t\t\t.attr(\"fill\", highlightColor)\r\n\t\t\t\t\t\t.attr(\"stroke\", \"#FF8C00\")\r\n\t\t\t\t\t\t.attr(\"stroke-width\", 2)\r\n\t\t\t\t\t\t.attr(\"class\", \"highlight-point\");\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tconst getCommonYears = (data1, data2) => {\r\n\t\tconst years1 = new Set(data1.map(d => d.year));\r\n\t\tconst years2 = new Set(data2.filter(d => d).map(d => d.year));\r\n\t\treturn [...years1].filter(year => years2.has(year));\r\n\t};\r\n\r\n\twatch(() => [props.data, props.compareData, props.title], drawChart, {\r\n\t\tdeep: true\r\n\t});\r\n\r\n\tonMounted(() => {\r\n\t\tsetTimeout(drawChart, 100);\r\n\t});\r\n</script>\r\n\r\n<style scoped>\r\n\t.full-chart {\r\n\t\twidth: 100%;\r\n\t\theight: 550px;\r\n\t\tposition: relative;\r\n\t}\r\n\r\n\t.no-data-message {\r\n\t\tposition: absolute;\r\n\t\ttop: 50%;\r\n\t\tleft: 50%;\r\n\t\ttransform: translate(-50%, -50%);\r\n\t\tcolor: #94a3b8;\r\n\t\tfont-size: 14px;\r\n\t}\r\n\r\n\t.team-legend {\r\n\t\tposition: absolute;\r\n\t\tbottom: 10px;\r\n\t\tleft: 50%;\r\n\t\ttransform: translateX(-50%);\r\n\t\tdisplay: flex;\r\n\t\tflex-wrap: wrap;\r\n\t\tjustify-content: center;\r\n\t\tgap: 15px;\r\n\t\tpadding: 8px 15px;\r\n\t\tbackground: rgba(255, 255, 255, 0.9);\r\n\t\tborder-radius: 4px;\r\n\t\tbox-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\r\n\t}\r\n\r\n\t.legend-item {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: 5px;\r\n\t}\r\n\r\n\t.legend-color {\r\n\t\tdisplay: inline-block;\r\n\t\twidth: 12px;\r\n\t\theight: 12px;\r\n\t\tborder-radius: 2px;\r\n\t}\r\n\r\n\t.legend-text {\r\n\t\tfont-size: 12px;\r\n\t\tcolor: #333;\r\n\t}\r\n\r\n\t.full-chart :deep(.highlight-point) {\r\n\t\tanimation: pulse 1.5s infinite;\r\n\t}\r\n\r\n\t@keyframes pulse {\r\n\t\t0% {\r\n\t\t\tr: 6;\r\n\t\t\topacity: 1;\r\n\t\t}\r\n\t\t50% {\r\n\t\t\tr: 9;\r\n\t\t\topacity: 0.8;\r\n\t\t}\r\n\t\t100% {\r\n\t\t\tr: 6;\r\n\t\t\topacity: 1;\r\n\t\t}\r\n\t}\r\n</style>\r\n"],"mappings":";;;EACMA,GAAG,EAAC,gBAAgB;EAACC,KAAK,EAAC;;;EADjCC,GAAA;EAEuBD,KAAK,EAAC;;;EAF7BC,GAAA;EAGoCD,KAAK,EAAC;;;EAKhCA,KAAK,EAAC;AAAa;;uBAP5BE,mBAAA,CAUM,OAVNC,UAUM,G,CATOC,MAAA,CAAAC,OAAO,I,cAAnBH,mBAAA,CAAyD,OAAzDI,UAAyD,EAAZ,QAAM,KAFrDC,mBAAA,gBAGaH,MAAA,CAAAI,UAAU,CAACC,MAAM,Q,cAA5BP,mBAAA,CAOM,OAPNQ,UAOM,I,kBANLR,mBAAA,CAKMS,SAAA,QATTC,WAAA,CAIuBR,MAAA,CAAAI,UAAU,EAAlBK,IAAI;yBAAhBX,mBAAA,CAKM;MAL2BD,GAAG,EAAEY,IAAI,CAACC,IAAI;MAAEd,KAAK,EAAC;QACtDe,mBAAA,CAEiD;MADhDf,KAAK,EAAC,cAAc;MACnBgB,KAAK,EAPXC,eAAA;QAAAC,eAAA,EAOgCL,IAAI,CAACM;MAAK;6BACtCJ,mBAAA,CAAgD,QAAhDK,UAAgD,EAAAC,gBAAA,CAAnBR,IAAI,CAACC,IAAI,iB;sCAR1CP,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}