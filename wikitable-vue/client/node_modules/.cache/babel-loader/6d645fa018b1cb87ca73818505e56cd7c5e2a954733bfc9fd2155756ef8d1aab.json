{"ast":null,"code":"import { toDisplayString as _toDisplayString, createElementVNode as _createElementVNode, openBlock as _openBlock, createElementBlock as _createElementBlock, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-3d881255\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  class: \"fixed-pie-chart\"\n};\nconst _hoisted_2 = {\n  class: \"chart-title\"\n};\nconst _hoisted_3 = {\n  ref: \"chartEl\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createElementVNode(\"div\", _hoisted_2, _toDisplayString($props.title), 1 /* TEXT */), (_openBlock(), _createElementBlock(\"svg\", _hoisted_3, null, 512 /* NEED_PATCH */))]);\n}","map":{"version":3,"names":["class","ref","_createElementBlock","_hoisted_1","_createElementVNode","_hoisted_2","_toDisplayString","$props","title","_hoisted_3"],"sources":["D:\\vue_frame\\vue_frame\\wikitable-vue\\client\\src\\components\\compoents_base\\charts\\PieChart.vue"],"sourcesContent":["<template>\r\n\t<div class=\"fixed-pie-chart\">\r\n\t\t<div class=\"chart-title\">{{ title }}</div>\r\n\t\t<svg ref=\"chartEl\"></svg>\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, onMounted, watch, computed, nextTick } from \"vue\";\r\n\timport * as d3 from \"d3\";\r\n\r\n\tconst props = defineProps({\r\n\t\tdata: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: () => [],\r\n\t\t\tvalidator: data => {\r\n\t\t\t\treturn data.every(item => {\r\n\t\t\t\t\treturn (\r\n\t\t\t\t\t\t(item.name && !isNaN(item.value)) ||\r\n\t\t\t\t\t\t(typeof item === \"string\" && item.includes(\":\"))\r\n\t\t\t\t\t);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\ttitle: String\r\n\t});\r\n\r\n\tconst chartEl = ref(null);\r\n\r\n\t// 数据标准化\r\n\tconst normalizedData = computed(() => {\r\n\t\treturn props.data\r\n\t\t\t.map(item => {\r\n\t\t\t\tif (typeof item === \"string\") {\r\n\t\t\t\t\tconst match = item.match(/(.*?):\\s*([\\d.]+)%?\\s*(?:\\((\\d{4})\\))?/);\r\n\t\t\t\t\tif (match) {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tname: match[1].trim(),\r\n\t\t\t\t\t\t\tvalue: parseFloat(match[2]),\r\n\t\t\t\t\t\t\tyear: match[3] || \"\"\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn { name: item, value: 0 };\r\n\t\t\t\t}\r\n\t\t\t\treturn {\r\n\t\t\t\t\tname: item.name,\r\n\t\t\t\t\tvalue: parseFloat(item.value),\r\n\t\t\t\t\tyear: item.year || \"\"\r\n\t\t\t\t};\r\n\t\t\t})\r\n\t\t\t.filter(item => !isNaN(item.value));\r\n\t});\r\n\r\n\t// 转为比例数据\r\n\tconst proportionalData = computed(() => {\r\n\t\tconst total = normalizedData.value.reduce(\r\n\t\t\t(sum, item) => sum + Math.abs(item.value),\r\n\t\t\t0\r\n\t\t);\r\n\t\treturn normalizedData.value.map(item => ({\r\n\t\t\t...item,\r\n\t\t\tdisplayValue: total > 0 ? (item.value / total) * 100 : 0\r\n\t\t}));\r\n\t});\r\n\r\n\tconst drawChart = () => {\r\n\t\tconst svg = d3.select(chartEl.value);\r\n\t\tsvg.selectAll(\"*\").remove(); // 清空旧图\r\n\r\n\t\tconst width = chartEl.value.clientWidth;\r\n\t\tconst height = chartEl.value.clientHeight || 400;\r\n\t\tconst radius = Math.min(width, height) / 2 - 10;\r\n\r\n\t\tsvg\r\n\t\t\t.attr(\"width\", width)\r\n\t\t\t.attr(\"height\", height)\r\n\t\t\t.style(\"font-family\", \"sans-serif\");\r\n\r\n\t\tconst g = svg\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"transform\", `translate(${width / 2}, ${height / 2})`);\r\n\r\n\t\tconst color = d3\r\n\t\t\t.scaleOrdinal()\r\n\t\t\t.domain(proportionalData.value.map(d => d.name))\r\n\t\t\t.range(d3.schemeTableau10);\r\n\r\n\t\tconst pie = d3\r\n\t\t\t.pie()\r\n\t\t\t.sort(null)\r\n\t\t\t.value(d => d.displayValue);\r\n\r\n\t\tconst arc = d3.arc().outerRadius(radius).innerRadius(0); // <-- 这里不设置内圈，变成实心扇形\r\n\r\n\t\tconst tooltip = d3\r\n\t\t\t.select(\"body\")\r\n\t\t\t.append(\"div\")\r\n\t\t\t.attr(\"class\", \"d3-tooltip\")\r\n\t\t\t.style(\"position\", \"absolute\")\r\n\t\t\t.style(\"text-align\", \"left\")\r\n\t\t\t.style(\"padding\", \"6px 10px\")\r\n\t\t\t.style(\"font\", \"12px sans-serif\")\r\n\t\t\t.style(\"background\", \"#fff\")\r\n\t\t\t.style(\"border\", \"1px solid #aaa\")\r\n\t\t\t.style(\"border-radius\", \"4px\")\r\n\t\t\t.style(\"pointer-events\", \"none\")\r\n\t\t\t.style(\"display\", \"none\")\r\n\t\t\t.style(\"z-index\", \"1000\");\r\n\r\n\t\tconst arcs = g\r\n\t\t\t.selectAll(\"path\")\r\n\t\t\t.data(pie(proportionalData.value))\r\n\t\t\t.join(\"path\")\r\n\t\t\t.attr(\"d\", arc)\r\n\t\t\t.attr(\"fill\", d => color(d.data.name))\r\n\t\t\t.attr(\"stroke\", \"white\")\r\n\t\t\t.style(\"stroke-width\", \"2px\")\r\n\t\t\t.on(\"mouseover\", function (event, d) {\r\n\t\t\t\td3.select(this).attr(\"opacity\", 0.7);\r\n\t\t\t\ttooltip\r\n\t\t\t\t\t.style(\"display\", \"block\")\r\n\t\t\t\t\t.html(\r\n\t\t\t\t\t\t`\r\n          <strong>${d.data.name}</strong><br/>\r\n          比例: ${d3.format(\".1f\")(d.data.displayValue)}%<br/>\r\n          ${d.data.year ? `年份: ${d.data.year}<br/>` : \"\"}\r\n          原始值: ${d3.format(\".2f\")(d.data.value)}%\r\n        `\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.style(\"left\", event.pageX + 10 + \"px\")\r\n\t\t\t\t\t.style(\"top\", event.pageY - 28 + \"px\");\r\n\t\t\t})\r\n\t\t\t.on(\"mouseout\", function () {\r\n\t\t\t\td3.select(this).attr(\"opacity\", 1);\r\n\t\t\t\ttooltip.style(\"display\", \"none\");\r\n\t\t\t});\r\n\r\n\t\tg.selectAll(\"text\")\r\n\t\t\t.data(pie(proportionalData.value))\r\n\t\t\t.join(\"text\")\r\n\t\t\t.attr(\"transform\", d => `translate(${arc.centroid(d)})`)\r\n\t\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t\t.style(\"fill\", \"#333\")\r\n\t\t\t.style(\"font-size\", \"12px\")\r\n\t\t\t.text(d => `${d.data.name}: ${d3.format(\".1f\")(d.data.displayValue)}%`);\r\n\t};\r\n\r\n\tonMounted(() => {\r\n\t\tnextTick(() => {\r\n\t\t\tdrawChart();\r\n\t\t\twindow.addEventListener(\"resize\", drawChart);\r\n\t\t});\r\n\t});\r\n\r\n\twatch(\r\n\t\t() => [props.data, props.title],\r\n\t\t() => nextTick(drawChart),\r\n\t\t{ deep: true }\r\n\t);\r\n</script>\r\n\r\n<style scoped>\r\n\t.fixed-pie-chart {\r\n\t\twidth: 100%;\r\n\t\theight: 400px;\r\n\t\tposition: relative;\r\n\t}\r\n\r\n\t.chart-title {\r\n\t\tposition: absolute;\r\n\t\ttop: 8px;\r\n\t\tleft: 50%;\r\n\t\ttransform: translateX(-50%);\r\n\t\tfont-weight: bold;\r\n\t\tfont-size: 16px;\r\n\t\tz-index: 10;\r\n\t}\r\n\r\n\t.d3-tooltip {\r\n\t\tpointer-events: none;\r\n\t}\r\n</style>\r\n"],"mappings":";;;EACMA,KAAK,EAAC;AAAiB;;EACtBA,KAAK,EAAC;AAAa;;EACnBC,GAAG,EAAC;AAAS;;uBAFnBC,mBAAA,CAGM,OAHNC,UAGM,GAFLC,mBAAA,CAA0C,OAA1CC,UAA0C,EAAAC,gBAAA,CAAdC,MAAA,CAAAC,KAAK,mB,cACjCN,mBAAA,CAAyB,OAAzBO,UAAyB,+B","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}