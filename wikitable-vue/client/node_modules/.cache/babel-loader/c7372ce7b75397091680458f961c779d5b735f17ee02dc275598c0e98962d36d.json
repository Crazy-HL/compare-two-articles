{"ast":null,"code":"import { ref, onMounted, watch, computed } from \"vue\";\nimport * as d3 from \"d3\";\nconst remainderColor = \"#f0f0f0\";\nexport default {\n  __name: 'PieChart',\n  props: {\n    data: {\n      type: Array,\n      default: () => [],\n      validator: value => value.every(item => \"name\" in item && \"value\" in item)\n    },\n    showRemainder: {\n      type: Boolean,\n      default: true\n    }\n  },\n  emits: [\"itemClick\"],\n  setup(__props, _ref) {\n    let {\n      expose: __expose,\n      emit: __emit\n    } = _ref;\n    __expose();\n    const props = __props;\n    const emit = __emit;\n    const chartContainer = ref(null);\n    const colors = [\"#3498db\", \"#e74c3c\", \"#2ecc71\", \"#f39c12\", \"#9b59b6\"];\n    const processedData = computed(() => {\n      if (!props.data.length) return [];\n\n      // 单值添加剩余部分\n      if (props.data.length === 1 && props.showRemainder) {\n        const mainValue = Math.min(100, Math.max(0, props.data[0].value));\n        return [{\n          ...props.data[0],\n          value: mainValue,\n          isMain: true,\n          index: 0\n        }, {\n          name: \"剩余\",\n          value: Math.max(0, 100 - mainValue),\n          isRemainder: true,\n          index: 1\n        }];\n      }\n      return props.data.map((item, index) => ({\n        ...item,\n        value: Math.min(100, Math.max(0, item.value)),\n        index\n      }));\n    });\n    let svg, arc, pie;\n    const initChart = () => {\n      if (!chartContainer.value || !processedData.value.length) return;\n\n      // 清除旧图表\n      d3.select(chartContainer.value).selectAll(\"*\").remove();\n      const container = d3.select(chartContainer.value);\n      const width = chartContainer.value.clientWidth;\n      const height = chartContainer.value.clientHeight;\n      const radius = Math.min(width, height) / 2;\n      svg = container.append(\"svg\").attr(\"width\", \"100%\").attr(\"height\", \"100%\").attr(\"viewBox\", `0 0 ${width} ${height}`).append(\"g\").attr(\"transform\", `translate(${width / 2},${height / 2})`);\n      pie = d3.pie().value(d => d.value).sort(null);\n      arc = d3.arc().innerRadius(0).outerRadius(radius * 0.9).cornerRadius(2);\n      drawChart();\n    };\n    const drawChart = () => {\n      const arcs = svg.selectAll(\".arc\").data(pie(processedData.value)).enter().append(\"g\").attr(\"class\", \"arc\");\n\n      // 绘制扇形\n      arcs.append(\"path\").attr(\"d\", arc).attr(\"fill\", d => d.data.isRemainder ? remainderColor : colors[d.data.index % colors.length]).style(\"opacity\", d => d.data.isRemainder ? 0.6 : 0.8).style(\"stroke\", \"#fff\").style(\"stroke-width\", 1).on(\"mouseover\", function (event, d) {\n        if (d.data.isRemainder) return;\n        d3.select(this).transition().duration(200).style(\"opacity\", 1);\n      }).on(\"mouseout\", function (event, d) {\n        if (d.data.isRemainder) return;\n        d3.select(this).transition().duration(200).style(\"opacity\", 0.8);\n      }).on(\"click\", (event, d) => {\n        if (d.data.isRemainder) return;\n        emit(\"itemClick\", d.data);\n      });\n\n      // 单值时添加中心文字\n      if (props.data.length === 1) {\n        svg.append(\"text\").attr(\"text-anchor\", \"middle\").attr(\"dy\", \".3em\").text(`${props.data[0].value.toFixed(1)}%`).style(\"font-size\", \"14px\").style(\"fill\", \"#333\");\n      }\n    };\n    onMounted(() => {\n      initChart();\n      window.addEventListener(\"resize\", initChart);\n    });\n    watch(() => props.data, initChart, {\n      deep: true\n    });\n    watch(() => props.showRemainder, initChart);\n    const __returned__ = {\n      props,\n      emit,\n      chartContainer,\n      colors,\n      remainderColor,\n      processedData,\n      get svg() {\n        return svg;\n      },\n      set svg(v) {\n        svg = v;\n      },\n      get arc() {\n        return arc;\n      },\n      set arc(v) {\n        arc = v;\n      },\n      get pie() {\n        return pie;\n      },\n      set pie(v) {\n        pie = v;\n      },\n      initChart,\n      drawChart,\n      ref,\n      onMounted,\n      watch,\n      computed,\n      get d3() {\n        return d3;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["ref","onMounted","watch","computed","d3","remainderColor","props","__props","emit","__emit","chartContainer","colors","processedData","data","length","showRemainder","mainValue","Math","min","max","value","isMain","index","name","isRemainder","map","item","svg","arc","pie","initChart","select","selectAll","remove","container","width","clientWidth","height","clientHeight","radius","append","attr","d","sort","innerRadius","outerRadius","cornerRadius","drawChart","arcs","enter","style","on","event","transition","duration","text","toFixed","window","addEventListener","deep"],"sources":["D:/vue_frame/vue_frame/wikitable-vue/client/src/components/compoents_base/charts/PieChart.vue"],"sourcesContent":["<template>\r\n\t<div ref=\"chartContainer\" class=\"pie-chart-container\"></div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, onMounted, watch, computed } from \"vue\";\r\n\timport * as d3 from \"d3\";\r\n\r\n\tconst props = defineProps({\r\n\t\tdata: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: () => [],\r\n\t\t\tvalidator: value => value.every(item => \"name\" in item && \"value\" in item)\r\n\t\t},\r\n\t\tshowRemainder: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: true\r\n\t\t}\r\n\t});\r\n\r\n\tconst emit = defineEmits([\"itemClick\"]);\r\n\r\n\tconst chartContainer = ref(null);\r\n\tconst colors = [\"#3498db\", \"#e74c3c\", \"#2ecc71\", \"#f39c12\", \"#9b59b6\"];\r\n\tconst remainderColor = \"#f0f0f0\";\r\n\r\n\tconst processedData = computed(() => {\r\n\t\tif (!props.data.length) return [];\r\n\r\n\t\t// 单值添加剩余部分\r\n\t\tif (props.data.length === 1 && props.showRemainder) {\r\n\t\t\tconst mainValue = Math.min(100, Math.max(0, props.data[0].value));\r\n\t\t\treturn [\r\n\t\t\t\t{ ...props.data[0], value: mainValue, isMain: true, index: 0 },\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"剩余\",\r\n\t\t\t\t\tvalue: Math.max(0, 100 - mainValue),\r\n\t\t\t\t\tisRemainder: true,\r\n\t\t\t\t\tindex: 1\r\n\t\t\t\t}\r\n\t\t\t];\r\n\t\t}\r\n\r\n\t\treturn props.data.map((item, index) => ({\r\n\t\t\t...item,\r\n\t\t\tvalue: Math.min(100, Math.max(0, item.value)),\r\n\t\t\tindex\r\n\t\t}));\r\n\t});\r\n\r\n\tlet svg, arc, pie;\r\n\r\n\tconst initChart = () => {\r\n\t\tif (!chartContainer.value || !processedData.value.length) return;\r\n\r\n\t\t// 清除旧图表\r\n\t\td3.select(chartContainer.value).selectAll(\"*\").remove();\r\n\r\n\t\tconst container = d3.select(chartContainer.value);\r\n\t\tconst width = chartContainer.value.clientWidth;\r\n\t\tconst height = chartContainer.value.clientHeight;\r\n\t\tconst radius = Math.min(width, height) / 2;\r\n\r\n\t\tsvg = container\r\n\t\t\t.append(\"svg\")\r\n\t\t\t.attr(\"width\", \"100%\")\r\n\t\t\t.attr(\"height\", \"100%\")\r\n\t\t\t.attr(\"viewBox\", `0 0 ${width} ${height}`)\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"transform\", `translate(${width / 2},${height / 2})`);\r\n\r\n\t\tpie = d3\r\n\t\t\t.pie()\r\n\t\t\t.value(d => d.value)\r\n\t\t\t.sort(null);\r\n\r\n\t\tarc = d3\r\n\t\t\t.arc()\r\n\t\t\t.innerRadius(0)\r\n\t\t\t.outerRadius(radius * 0.9)\r\n\t\t\t.cornerRadius(2);\r\n\r\n\t\tdrawChart();\r\n\t};\r\n\r\n\tconst drawChart = () => {\r\n\t\tconst arcs = svg\r\n\t\t\t.selectAll(\".arc\")\r\n\t\t\t.data(pie(processedData.value))\r\n\t\t\t.enter()\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"class\", \"arc\");\r\n\r\n\t\t// 绘制扇形\r\n\t\tarcs\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"d\", arc)\r\n\t\t\t.attr(\"fill\", d =>\r\n\t\t\t\td.data.isRemainder\r\n\t\t\t\t\t? remainderColor\r\n\t\t\t\t\t: colors[d.data.index % colors.length]\r\n\t\t\t)\r\n\t\t\t.style(\"opacity\", d => (d.data.isRemainder ? 0.6 : 0.8))\r\n\t\t\t.style(\"stroke\", \"#fff\")\r\n\t\t\t.style(\"stroke-width\", 1)\r\n\t\t\t.on(\"mouseover\", function (event, d) {\r\n\t\t\t\tif (d.data.isRemainder) return;\r\n\t\t\t\td3.select(this).transition().duration(200).style(\"opacity\", 1);\r\n\t\t\t})\r\n\t\t\t.on(\"mouseout\", function (event, d) {\r\n\t\t\t\tif (d.data.isRemainder) return;\r\n\t\t\t\td3.select(this).transition().duration(200).style(\"opacity\", 0.8);\r\n\t\t\t})\r\n\t\t\t.on(\"click\", (event, d) => {\r\n\t\t\t\tif (d.data.isRemainder) return;\r\n\t\t\t\temit(\"itemClick\", d.data);\r\n\t\t\t});\r\n\r\n\t\t// 单值时添加中心文字\r\n\t\tif (props.data.length === 1) {\r\n\t\t\tsvg\r\n\t\t\t\t.append(\"text\")\r\n\t\t\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t\t\t.attr(\"dy\", \".3em\")\r\n\t\t\t\t.text(`${props.data[0].value.toFixed(1)}%`)\r\n\t\t\t\t.style(\"font-size\", \"14px\")\r\n\t\t\t\t.style(\"fill\", \"#333\");\r\n\t\t}\r\n\t};\r\n\r\n\tonMounted(() => {\r\n\t\tinitChart();\r\n\t\twindow.addEventListener(\"resize\", initChart);\r\n\t});\r\n\r\n\twatch(() => props.data, initChart, { deep: true });\r\n\twatch(() => props.showRemainder, initChart);\r\n</script>\r\n\r\n<style scoped>\r\n\t.pie-chart-container {\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t\tmin-height: 150px;\r\n\t}\r\n</style>\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}