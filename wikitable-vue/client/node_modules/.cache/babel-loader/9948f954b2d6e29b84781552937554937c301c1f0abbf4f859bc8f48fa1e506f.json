{"ast":null,"code":"import { ref, computed, watch, onMounted, onUnmounted } from \"vue\";\nexport default {\n  __name: 'TextPopup',\n  props: {\n    visible: Boolean,\n    // 是否显示弹出框\n    content: String,\n    // 弹出框内容\n    containerClass: String,\n    // 图表容器类名\n    containerRef: {\n      type: Object,\n      default: () => ({\n        value: null\n      }) // 默认值为 { value: null }\n    }\n  },\n  emits: [\"close\"],\n  setup(__props, _ref) {\n    let {\n      expose: __expose,\n      emit: __emit\n    } = _ref;\n    __expose();\n    const props = __props;\n    const emit = __emit; // 定义 close 事件\n\n    const popupRef = ref(null); // 弹出框的引用\n    const currentView = ref(\"text\"); // 当前视图模式：text 或 visual\n    const loading = ref(false); // 可视化图表加载状态\n    const popupStyle = ref({}); // 弹出框的样式\n\n    // 判断内容是否是表格\n    const isTable = computed(() => {\n      return /<table.*?>.*?<\\/table>/s.test(props.content);\n    });\n\n    // 关闭弹出框\n    const close = () => {\n      emit(\"close\");\n    };\n\n    // 切换视图\n    const switchView = async view => {\n      currentView.value = view;\n      if (view === \"visual\") {\n        loading.value = true;\n        await processText(); // 调用后端处理文本并渲染图表\n        loading.value = false;\n      }\n    };\n\n    // 获取可视化 JSON 数据\n    async function processText() {\n      try {\n        api.post(\"process_text\", {\n          text: props.content.toString().trim()\n        }, data => {\n          if (data.error) {\n            console.error(\"后端返回的错误:\", data.error);\n            alert(`处理文章内容时出错: ${data.message}`);\n            return;\n          }\n          const jsonData = data.json_data;\n          console.log(\"后端返回的数据:\", jsonData);\n\n          // 清空之前的图表\n          d3.select(`.${props.containerClass}`).html(\"\");\n          if (data.data_type === \"Non-Visual\") {\n            renderNonVisualChart(`.${props.containerClass}`, data, {\n              message: \"当前数据无法可视化\"\n            });\n          } else {\n            renderChart(jsonData, data.chart_classification);\n          }\n        });\n      } catch (error) {\n        console.error(\"处理文章内容时出错:\", error);\n        alert(\"处理文章内容时出错，请稍后重试\");\n      }\n    }\n\n    // 渲染图表\n    function renderChart(rawJsonData, chartType) {\n      if (!rawJsonData || typeof rawJsonData !== \"object\" || !rawJsonData.data) {\n        renderNonVisualChart(`.${props.containerClass}`, rawJsonData, {\n          message: \"JSON 数据无效\"\n        });\n        console.error(\"JSON 数据无效:\", rawJsonData);\n        return;\n      }\n      const data = rawJsonData.data;\n      const options = rawJsonData.options || {};\n\n      // 根据图表类型渲染\n      if (chartType === \"Line Chart\") {\n        renderLineChart(`.${props.containerClass}`, data, options);\n      } else if (chartType === \"Bar Chart\") {\n        renderBarChart(`.${props.containerClass}`, data, options);\n      } else if (chartType === \"Pie Chart\") {\n        renderPieChart(`.${props.containerClass}`, data, options);\n      } else if (chartType === \"Stacked Bar Chart\") {\n        renderStackedBarChart(`.${props.containerClass}`, data, options);\n      } else {\n        console.error(\"未知的图表类型:\", chartType);\n      }\n    }\n\n    // 更新弹出框的位置和尺寸\n    const updatePopupPosition = () => {\n      if (props.visible && props.containerRef && props.containerRef.value) {\n        const containerRect = props.containerRef.value.getBoundingClientRect();\n        popupStyle.value = {\n          position: \"absolute\",\n          top: `${containerRect.top + window.scrollY}px`,\n          left: `${containerRect.left + window.scrollX}px`,\n          width: `${containerRect.width}px`,\n          maxHeight: `${containerRect.height}px`\n        };\n      }\n    };\n\n    // 监听 containerRef 的变化\n    watch(() => props.containerRef.value, newValue => {\n      if (newValue) {\n        // 绑定事件\n        window.addEventListener(\"resize\", updatePopupPosition);\n        newValue.addEventListener(\"scroll\", updatePopupPosition);\n        // 初始化弹出框位置\n        updatePopupPosition();\n      }\n    }, {\n      immediate: true\n    });\n\n    // 组件卸载时解绑事件\n    onUnmounted(() => {\n      if (props.containerRef && props.containerRef.value) {\n        window.removeEventListener(\"resize\", updatePopupPosition);\n        props.containerRef.value.removeEventListener(\"scroll\", updatePopupPosition);\n      }\n    });\n    const __returned__ = {\n      props,\n      emit,\n      popupRef,\n      currentView,\n      loading,\n      popupStyle,\n      isTable,\n      close,\n      switchView,\n      processText,\n      renderChart,\n      updatePopupPosition,\n      ref,\n      computed,\n      watch,\n      onMounted,\n      onUnmounted\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["ref","computed","watch","onMounted","onUnmounted","props","__props","emit","__emit","popupRef","currentView","loading","popupStyle","isTable","test","content","close","switchView","view","value","processText","api","post","text","toString","trim","data","error","console","alert","message","jsonData","json_data","log","d3","select","containerClass","html","data_type","renderNonVisualChart","renderChart","chart_classification","rawJsonData","chartType","options","renderLineChart","renderBarChart","renderPieChart","renderStackedBarChart","updatePopupPosition","visible","containerRef","containerRect","getBoundingClientRect","position","top","window","scrollY","left","scrollX","width","maxHeight","height","newValue","addEventListener","immediate","removeEventListener"],"sources":["D:/vue_frame/vue_frame/wikitable-vue/client/src/components/compoents_base/TextPopup.vue"],"sourcesContent":["<template>\r\n\t<!-- 遮罩层 -->\r\n\t<div v-if=\"visible\" class=\"overlay\" @click=\"close\"></div>\r\n\r\n\t<!-- 弹出框 -->\r\n\t<div\r\n\t\tv-if=\"visible\"\r\n\t\tref=\"popupRef\"\r\n\t\tclass=\"text-popup\"\r\n\t\t:style=\"popupStyle\"\r\n\t\t@click.stop>\r\n\t\t<!-- 切换视图按钮 -->\r\n\t\t<div class=\"view-switcher\">\r\n\t\t\t<button\r\n\t\t\t\t@click.prevent.stop=\"switchView('text')\"\r\n\t\t\t\t:class=\"{ active: currentView === 'text' }\"\r\n\t\t\t\ttitle=\"文本视图\">\r\n\t\t\t\t<font-awesome-icon :icon=\"['fas', 'align-left']\" />\r\n\t\t\t</button>\r\n\r\n\t\t\t<button\r\n\t\t\t\t@click.prevent.stop=\"switchView('visual')\"\r\n\t\t\t\t:class=\"{ active: currentView === 'visual' }\"\r\n\t\t\t\ttitle=\"可视化视图\">\r\n\t\t\t\t<font-awesome-icon :icon=\"['fas', 'chart-bar']\" />\r\n\t\t\t</button>\r\n\t\t</div>\r\n\r\n\t\t<!-- 文本视图 -->\r\n\t\t<div v-if=\"currentView === 'text'\">\r\n\t\t\t<div v-if=\"isTable\" class=\"table-container\" v-html=\"content\"></div>\r\n\t\t\t<div v-else>\r\n\t\t\t\t<p>{{ content }}</p>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\r\n\t\t<!-- 可视化视图 -->\r\n\t\t<div v-if=\"currentView === 'visual'\" class=\"visualization-container\">\r\n\t\t\t<div v-if=\"loading\" class=\"loading-spinner\"></div>\r\n\t\t\t<div v-else :class=\"containerClass\"></div>\r\n\t\t</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, computed, watch, onMounted, onUnmounted } from \"vue\";\r\n\r\n\tconst props = defineProps({\r\n\t\tvisible: Boolean, // 是否显示弹出框\r\n\t\tcontent: String, // 弹出框内容\r\n\t\tcontainerClass: String, // 图表容器类名\r\n\t\tcontainerRef: {\r\n\t\t\ttype: Object,\r\n\t\t\tdefault: () => ({ value: null }) // 默认值为 { value: null }\r\n\t\t}\r\n\t});\r\n\r\n\tconst emit = defineEmits([\"close\"]); // 定义 close 事件\r\n\r\n\tconst popupRef = ref(null); // 弹出框的引用\r\n\tconst currentView = ref(\"text\"); // 当前视图模式：text 或 visual\r\n\tconst loading = ref(false); // 可视化图表加载状态\r\n\tconst popupStyle = ref({}); // 弹出框的样式\r\n\r\n\t// 判断内容是否是表格\r\n\tconst isTable = computed(() => {\r\n\t\treturn /<table.*?>.*?<\\/table>/s.test(props.content);\r\n\t});\r\n\r\n\t// 关闭弹出框\r\n\tconst close = () => {\r\n\t\temit(\"close\");\r\n\t};\r\n\r\n\t// 切换视图\r\n\tconst switchView = async view => {\r\n\t\tcurrentView.value = view;\r\n\t\tif (view === \"visual\") {\r\n\t\t\tloading.value = true;\r\n\t\t\tawait processText(); // 调用后端处理文本并渲染图表\r\n\t\t\tloading.value = false;\r\n\t\t}\r\n\t};\r\n\r\n\t// 获取可视化 JSON 数据\r\n\tasync function processText() {\r\n\t\ttry {\r\n\t\t\tapi.post(\r\n\t\t\t\t\"process_text\",\r\n\t\t\t\t{ text: props.content.toString().trim() },\r\n\t\t\t\tdata => {\r\n\t\t\t\t\tif (data.error) {\r\n\t\t\t\t\t\tconsole.error(\"后端返回的错误:\", data.error);\r\n\t\t\t\t\t\talert(`处理文章内容时出错: ${data.message}`);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst jsonData = data.json_data;\r\n\t\t\t\t\tconsole.log(\"后端返回的数据:\", jsonData);\r\n\r\n\t\t\t\t\t// 清空之前的图表\r\n\t\t\t\t\td3.select(`.${props.containerClass}`).html(\"\");\r\n\r\n\t\t\t\t\tif (data.data_type === \"Non-Visual\") {\r\n\t\t\t\t\t\trenderNonVisualChart(`.${props.containerClass}`, data, {\r\n\t\t\t\t\t\t\tmessage: \"当前数据无法可视化\"\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\trenderChart(jsonData, data.chart_classification);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"处理文章内容时出错:\", error);\r\n\t\t\talert(\"处理文章内容时出错，请稍后重试\");\r\n\t\t}\r\n\t}\r\n\r\n\t// 渲染图表\r\n\tfunction renderChart(rawJsonData, chartType) {\r\n\t\tif (!rawJsonData || typeof rawJsonData !== \"object\" || !rawJsonData.data) {\r\n\t\t\trenderNonVisualChart(`.${props.containerClass}`, rawJsonData, {\r\n\t\t\t\tmessage: \"JSON 数据无效\"\r\n\t\t\t});\r\n\t\t\tconsole.error(\"JSON 数据无效:\", rawJsonData);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst data = rawJsonData.data;\r\n\t\tconst options = rawJsonData.options || {};\r\n\r\n\t\t// 根据图表类型渲染\r\n\t\tif (chartType === \"Line Chart\") {\r\n\t\t\trenderLineChart(`.${props.containerClass}`, data, options);\r\n\t\t} else if (chartType === \"Bar Chart\") {\r\n\t\t\trenderBarChart(`.${props.containerClass}`, data, options);\r\n\t\t} else if (chartType === \"Pie Chart\") {\r\n\t\t\trenderPieChart(`.${props.containerClass}`, data, options);\r\n\t\t} else if (chartType === \"Stacked Bar Chart\") {\r\n\t\t\trenderStackedBarChart(`.${props.containerClass}`, data, options);\r\n\t\t} else {\r\n\t\t\tconsole.error(\"未知的图表类型:\", chartType);\r\n\t\t}\r\n\t}\r\n\r\n\t// 更新弹出框的位置和尺寸\r\n\tconst updatePopupPosition = () => {\r\n\t\tif (props.visible && props.containerRef && props.containerRef.value) {\r\n\t\t\tconst containerRect = props.containerRef.value.getBoundingClientRect();\r\n\t\t\tpopupStyle.value = {\r\n\t\t\t\tposition: \"absolute\",\r\n\t\t\t\ttop: `${containerRect.top + window.scrollY}px`,\r\n\t\t\t\tleft: `${containerRect.left + window.scrollX}px`,\r\n\t\t\t\twidth: `${containerRect.width}px`,\r\n\t\t\t\tmaxHeight: `${containerRect.height}px`\r\n\t\t\t};\r\n\t\t}\r\n\t};\r\n\r\n\t// 监听 containerRef 的变化\r\n\twatch(\r\n\t\t() => props.containerRef.value,\r\n\t\tnewValue => {\r\n\t\t\tif (newValue) {\r\n\t\t\t\t// 绑定事件\r\n\t\t\t\twindow.addEventListener(\"resize\", updatePopupPosition);\r\n\t\t\t\tnewValue.addEventListener(\"scroll\", updatePopupPosition);\r\n\t\t\t\t// 初始化弹出框位置\r\n\t\t\t\tupdatePopupPosition();\r\n\t\t\t}\r\n\t\t},\r\n\t\t{ immediate: true }\r\n\t);\r\n\r\n\t// 组件卸载时解绑事件\r\n\tonUnmounted(() => {\r\n\t\tif (props.containerRef && props.containerRef.value) {\r\n\t\t\twindow.removeEventListener(\"resize\", updatePopupPosition);\r\n\t\t\tprops.containerRef.value.removeEventListener(\r\n\t\t\t\t\"scroll\",\r\n\t\t\t\tupdatePopupPosition\r\n\t\t\t);\r\n\t\t}\r\n\t});\r\n</script>\r\n\r\n<style scoped>\r\n\t/* 样式保持不变 */\r\n</style>\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}