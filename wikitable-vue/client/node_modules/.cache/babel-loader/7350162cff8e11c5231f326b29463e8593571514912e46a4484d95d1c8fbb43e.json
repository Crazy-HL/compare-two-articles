{"ast":null,"code":"import { toDisplayString as _toDisplayString, createElementVNode as _createElementVNode, openBlock as _openBlock, createElementBlock as _createElementBlock, renderList as _renderList, Fragment as _Fragment, normalizeStyle as _normalizeStyle, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-3d881255\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  class: \"fixed-pie-chart\"\n};\nconst _hoisted_2 = {\n  class: \"chart-title\"\n};\nconst _hoisted_3 = {\n  class: \"chart-container\"\n};\nconst _hoisted_4 = {\n  ref: \"chartEl\"\n};\nconst _hoisted_5 = {\n  class: \"legend\",\n  ref: \"legendEl\"\n};\nconst _hoisted_6 = {\n  class: \"legend-text\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createElementVNode(\"div\", _hoisted_2, _toDisplayString($props.title), 1 /* TEXT */), _createElementVNode(\"div\", _hoisted_3, [(_openBlock(), _createElementBlock(\"svg\", _hoisted_4, null, 512 /* NEED_PATCH */)), _createElementVNode(\"div\", _hoisted_5, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.proportionalData, (item, index) => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: item.name,\n      class: \"legend-item\"\n    }, [_createElementVNode(\"span\", {\n      class: \"legend-color\",\n      style: _normalizeStyle({\n        backgroundColor: $setup.colorScale(item.name)\n      })\n    }, null, 4 /* STYLE */), _createElementVNode(\"span\", _hoisted_6, _toDisplayString(item.name) + \": \" + _toDisplayString(item.displayValue.toFixed(1)) + \"% \", 1 /* TEXT */)]);\n  }), 128 /* KEYED_FRAGMENT */))], 512 /* NEED_PATCH */)])]);\n}","map":{"version":3,"names":["class","ref","_createElementBlock","_hoisted_1","_createElementVNode","_hoisted_2","_toDisplayString","$props","title","_hoisted_3","_hoisted_4","_hoisted_5","_Fragment","_renderList","$setup","proportionalData","item","index","key","name","style","_normalizeStyle","backgroundColor","colorScale","_hoisted_6","displayValue","toFixed"],"sources":["D:\\vue_frame\\vue_frame\\wikitable-vue\\client\\src\\components\\compoents_base\\charts\\PieChart.vue"],"sourcesContent":["<template>\r\n\t<div class=\"fixed-pie-chart\">\r\n\t\t<div class=\"chart-title\">{{ title }}</div>\r\n\t\t<div class=\"chart-container\">\r\n\t\t\t<svg ref=\"chartEl\"></svg>\r\n\t\t\t<div class=\"legend\" ref=\"legendEl\">\r\n\t\t\t\t<div\r\n\t\t\t\t\tv-for=\"(item, index) in proportionalData\"\r\n\t\t\t\t\t:key=\"item.name\"\r\n\t\t\t\t\tclass=\"legend-item\">\r\n\t\t\t\t\t<span\r\n\t\t\t\t\t\tclass=\"legend-color\"\r\n\t\t\t\t\t\t:style=\"{ backgroundColor: colorScale(item.name) }\"></span>\r\n\t\t\t\t\t<span class=\"legend-text\">\r\n\t\t\t\t\t\t{{ item.name }}: {{ item.displayValue.toFixed(1) }}%\r\n\t\t\t\t\t</span>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, onMounted, watch, computed, nextTick } from \"vue\";\r\n\timport * as d3 from \"d3\";\r\n\r\n\tconst props = defineProps({\r\n\t\tdata: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: () => [],\r\n\t\t\tvalidator: data => {\r\n\t\t\t\treturn data.every(item => {\r\n\t\t\t\t\treturn (\r\n\t\t\t\t\t\t(item.name && !isNaN(item.value)) ||\r\n\t\t\t\t\t\t(typeof item === \"string\" && item.includes(\":\"))\r\n\t\t\t\t\t);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\ttitle: String\r\n\t});\r\n\r\n\tconst chartEl = ref(null);\r\n\tconst legendEl = ref(null);\r\n\r\n\t// 数据标准化\r\n\tconst normalizedData = computed(() => {\r\n\t\treturn props.data\r\n\t\t\t.map(item => {\r\n\t\t\t\tif (typeof item === \"string\") {\r\n\t\t\t\t\tconst match = item.match(/(.*?):\\s*([\\d.]+)%?\\s*(?:\\((\\d{4})\\))?/);\r\n\t\t\t\t\tif (match) {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tname: match[1].trim(),\r\n\t\t\t\t\t\t\tvalue: parseFloat(match[2]),\r\n\t\t\t\t\t\t\tyear: match[3] || \"\"\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn { name: item, value: 0 };\r\n\t\t\t\t}\r\n\t\t\t\treturn {\r\n\t\t\t\t\tname: item.name,\r\n\t\t\t\t\tvalue: parseFloat(item.value),\r\n\t\t\t\t\tyear: item.year || \"\"\r\n\t\t\t\t};\r\n\t\t\t})\r\n\t\t\t.filter(item => !isNaN(item.value));\r\n\t});\r\n\r\n\t// 转为比例数据\r\n\tconst proportionalData = computed(() => {\r\n\t\tconst total = normalizedData.value.reduce(\r\n\t\t\t(sum, item) => sum + Math.abs(item.value),\r\n\t\t\t0\r\n\t\t);\r\n\t\treturn normalizedData.value.map(item => ({\r\n\t\t\t...item,\r\n\t\t\tdisplayValue: total > 0 ? (item.value / total) * 100 : 0\r\n\t\t}));\r\n\t});\r\n\r\n\tconst colorScale = d3.scaleOrdinal(d3.schemeTableau10);\r\n\r\n\tconst drawChart = () => {\r\n\t\tconst svg = d3.select(chartEl.value);\r\n\t\tsvg.selectAll(\"*\").remove(); // 清空旧图\r\n\r\n\t\tconst container = chartEl.value.parentElement;\r\n\t\tconst width = container.clientWidth * 0.65; // 饼图区域宽度（图注预留35%）\r\n\t\tconst height = container.clientHeight;\r\n\t\tconst radius = Math.min(width, height) / 2 - 20;\r\n\r\n\t\tsvg.attr(\"width\", width).attr(\"height\", height);\r\n\r\n\t\tconst g = svg\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"transform\", `translate(${width / 2}, ${height / 2})`);\r\n\r\n\t\tconst pie = d3\r\n\t\t\t.pie()\r\n\t\t\t.sort(null)\r\n\t\t\t.value(d => d.displayValue);\r\n\r\n\t\tconst arc = d3.arc().outerRadius(radius).innerRadius(0);\r\n\r\n\t\tconst tooltip = d3\r\n\t\t\t.select(\"body\")\r\n\t\t\t.append(\"div\")\r\n\t\t\t.attr(\"class\", \"d3-tooltip\")\r\n\t\t\t.style(\"position\", \"absolute\")\r\n\t\t\t.style(\"text-align\", \"left\")\r\n\t\t\t.style(\"padding\", \"6px 10px\")\r\n\t\t\t.style(\"font\", \"12px sans-serif\")\r\n\t\t\t.style(\"background\", \"#fff\")\r\n\t\t\t.style(\"border\", \"1px solid #aaa\")\r\n\t\t\t.style(\"border-radius\", \"4px\")\r\n\t\t\t.style(\"pointer-events\", \"none\")\r\n\t\t\t.style(\"display\", \"none\")\r\n\t\t\t.style(\"z-index\", \"1000\");\r\n\r\n\t\tg.selectAll(\"path\")\r\n\t\t\t.data(pie(proportionalData.value))\r\n\t\t\t.join(\"path\")\r\n\t\t\t.attr(\"d\", arc)\r\n\t\t\t.attr(\"fill\", d => colorScale(d.data.name))\r\n\t\t\t.attr(\"stroke\", \"white\")\r\n\t\t\t.style(\"stroke-width\", \"2px\")\r\n\t\t\t.on(\"mouseover\", function (event, d) {\r\n\t\t\t\td3.select(this).attr(\"opacity\", 0.7);\r\n\t\t\t\ttooltip\r\n\t\t\t\t\t.style(\"display\", \"block\")\r\n\t\t\t\t\t.html(\r\n\t\t\t\t\t\t`\r\n          <strong>${d.data.name}</strong><br/>\r\n          比例: ${d3.format(\".1f\")(d.data.displayValue)}%<br/>\r\n          ${d.data.year ? `年份: ${d.data.year}<br/>` : \"\"}\r\n          原始值: ${d3.format(\".2f\")(d.data.value)}%\r\n        `\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.style(\"left\", event.pageX + 10 + \"px\")\r\n\t\t\t\t\t.style(\"top\", event.pageY - 28 + \"px\");\r\n\t\t\t})\r\n\t\t\t.on(\"mouseout\", function () {\r\n\t\t\t\td3.select(this).attr(\"opacity\", 1);\r\n\t\t\t\ttooltip.style(\"display\", \"none\");\r\n\t\t\t});\r\n\r\n\t\tg.selectAll(\"text\")\r\n\t\t\t.data(pie(proportionalData.value))\r\n\t\t\t.join(\"text\")\r\n\t\t\t.attr(\"transform\", d => `translate(${arc.centroid(d)})`)\r\n\t\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t\t.style(\"fill\", \"#333\")\r\n\t\t\t.style(\"font-size\", \"12px\")\r\n\t\t\t.text(d => `${d.data.displayValue.toFixed(1)}%`);\r\n\t};\r\n\r\n\tonMounted(() => {\r\n\t\tnextTick(() => {\r\n\t\t\tdrawChart();\r\n\t\t\twindow.addEventListener(\"resize\", drawChart);\r\n\t\t});\r\n\t});\r\n\r\n\twatch(\r\n\t\t() => [props.data, props.title],\r\n\t\t() => nextTick(drawChart),\r\n\t\t{ deep: true }\r\n\t);\r\n</script>\r\n\r\n<style scoped>\r\n\t.fixed-pie-chart {\r\n\t\twidth: 100%;\r\n\t\theight: 400px;\r\n\t\tposition: relative;\r\n\t}\r\n\r\n\t.chart-title {\r\n\t\ttext-align: center;\r\n\t\tfont-weight: bold;\r\n\t\tfont-size: 16px;\r\n\t\tmargin-bottom: 10px;\r\n\t}\r\n\r\n\t.chart-container {\r\n\t\tdisplay: flex;\r\n\t\tjustify-content: space-between;\r\n\t\talign-items: center;\r\n\t\theight: 100%;\r\n\t}\r\n\r\n\tsvg {\r\n\t\tflex: 1 1 65%;\r\n\t\theight: 100%;\r\n\t}\r\n\r\n\t.legend {\r\n\t\tflex: 1 1 35%;\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tjustify-content: center;\r\n\t\tgap: 6px;\r\n\t\tpadding-left: 10px;\r\n\t\tfont-size: 13px;\r\n\t\toverflow-y: auto;\r\n\t}\r\n\r\n\t.legend-item {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t}\r\n\r\n\t.legend-color {\r\n\t\twidth: 14px;\r\n\t\theight: 14px;\r\n\t\tmargin-right: 6px;\r\n\t\tborder-radius: 2px;\r\n\t}\r\n</style>\r\n"],"mappings":";;;EACMA,KAAK,EAAC;AAAiB;;EACtBA,KAAK,EAAC;AAAa;;EACnBA,KAAK,EAAC;AAAiB;;EACtBC,GAAG,EAAC;AAAS;;EACbD,KAAK,EAAC,QAAQ;EAACC,GAAG,EAAC;;;EAQhBD,KAAK,EAAC;AAAa;;uBAZ7BE,mBAAA,CAkBM,OAlBNC,UAkBM,GAjBLC,mBAAA,CAA0C,OAA1CC,UAA0C,EAAAC,gBAAA,CAAdC,MAAA,CAAAC,KAAK,kBACjCJ,mBAAA,CAeM,OAfNK,UAeM,I,cAdLP,mBAAA,CAAyB,OAAzBQ,UAAyB,gCACzBN,mBAAA,CAYM,OAZNO,UAYM,I,kBAXLT,mBAAA,CAUMU,SAAA,QAhBVC,WAAA,CAO6BC,MAAA,CAAAC,gBAAgB,EAP7C,CAOaC,IAAI,EAAEC,KAAK;yBADpBf,mBAAA,CAUM;MARJgB,GAAG,EAAEF,IAAI,CAACG,IAAI;MACfnB,KAAK,EAAC;QACNI,mBAAA,CAE4D;MAD3DJ,KAAK,EAAC,cAAc;MACnBoB,KAAK,EAZZC,eAAA;QAAAC,eAAA,EAYiCR,MAAA,CAAAS,UAAU,CAACP,IAAI,CAACG,IAAI;MAAA;6BAChDf,mBAAA,CAEO,QAFPoB,UAEO,EAAAlB,gBAAA,CADHU,IAAI,CAACG,IAAI,IAAG,IAAE,GAAAb,gBAAA,CAAGU,IAAI,CAACS,YAAY,CAACC,OAAO,OAAM,IACpD,gB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}