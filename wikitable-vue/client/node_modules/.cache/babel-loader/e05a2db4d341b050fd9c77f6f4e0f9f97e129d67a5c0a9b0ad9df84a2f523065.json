{"ast":null,"code":"import { ref, onMounted, onUnmounted } from \"vue\";\nimport LoadingSpinner from \"./LoadingSpinner.vue\";\nimport ErrorDisplay from \"./ErrorDisplay.vue\";\nimport WikipediaContent from \"./WikipediaContent.vue\";\nimport { fetchWikipediaContent, injectWikipediaStyles } from \"@/js/apiUtils\";\nimport * as d3 from \"d3\";\nimport { renderChart } from \"@/js/chartUtils\";\nexport default {\n  __name: 'MainComponent',\n  props: {\n    pageTitle: String,\n    divId: String,\n    selectContentClass: String\n  },\n  setup(__props, _ref) {\n    let {\n      expose: __expose\n    } = _ref;\n    __expose();\n    const props = __props;\n    const pageHtml = ref(\"\");\n    const loading = ref(true);\n    const error = ref(\"\");\n    const selectedText = ref({});\n    const showPopup = ref({});\n    const divRef = ref(null);\n    const currentView = ref(\"text\");\n    const visualizationLoading = ref(false);\n    const handleSelection = () => {\n      const selection = window.getSelection();\n      if (!selection.rangeCount) return;\n      const range = selection.getRangeAt(0);\n      const selectedHtml = range.cloneContents();\n      const tempDiv = document.createElement(\"div\");\n      tempDiv.appendChild(selectedHtml);\n      const table = tempDiv.querySelector(\"table\");\n      if (table) {\n        table.classList.add(\"custom-table\");\n        selectedText.value[props.divId] = tempDiv.innerHTML;\n      } else {\n        const text = selection.toString().trim();\n        if (!text) return;\n        selectedText.value[props.divId] = text;\n      }\n      showPopup.value[props.divId] = true;\n      currentView.value = \"text\";\n    };\n    const closePopup = () => {\n      showPopup.value[props.divId] = false;\n      selectedText.value[props.divId] = \"\";\n      const container = props.divId === \"div1\" ? \".chart-container1\" : \".chart-container2\";\n      d3.select(container).html(\"\");\n    };\n    const switchView = async view => {\n      currentView.value = view;\n      if (view === \"visual\") {\n        visualizationLoading.value = true;\n        await processText();\n        visualizationLoading.value = false;\n      }\n    };\n    async function processText() {\n      try {\n        api.post(\"process_text\", {\n          text: selectedText.value[props.divId].toString().trim()\n        },\n        // 使用对应 divId 的选中内容\n        data => {\n          if (data.error) {\n            console.error(\"后端返回的错误:\", data.error);\n            alert(`处理文章内容时出错: ${data.message}`);\n            return;\n          }\n          const jsonData = data.json_data;\n          console.log(\"后端返回的数据:\", jsonData);\n\n          // 根据 divId 选择容器\n          const container = props.divId === \"div1\" ? \".chart-container1\" : \".chart-container2\";\n          if (data.data_type === \"Non-Visual\") {\n            renderNonVisualChart(container, data, {\n              message: \"当前数据无法可视化\"\n            });\n          } else {\n            renderChart(jsonData, data.chart_classification);\n          }\n        });\n      } catch (error) {\n        console.error(\"处理文章内容时出错:\", error);\n        alert(\"处理文章内容时出错，请稍后重试\");\n      }\n    }\n    onMounted(() => {\n      fetchWikipediaContent(props.pageTitle).then(html => {\n        pageHtml.value = html;\n        injectWikipediaStyles();\n      }).catch(err => {\n        error.value = err.message;\n      }).finally(() => {\n        loading.value = false;\n      });\n      if (divRef.value) {\n        divRef.value.addEventListener(\"mouseup\", handleSelection);\n      }\n    });\n    onUnmounted(() => {\n      if (divRef.value) {\n        divRef.value.removeEventListener(\"mouseup\", handleSelection);\n      }\n    });\n    const __returned__ = {\n      props,\n      pageHtml,\n      loading,\n      error,\n      selectedText,\n      showPopup,\n      divRef,\n      currentView,\n      visualizationLoading,\n      handleSelection,\n      closePopup,\n      switchView,\n      processText,\n      ref,\n      onMounted,\n      onUnmounted,\n      LoadingSpinner,\n      ErrorDisplay,\n      WikipediaContent,\n      get fetchWikipediaContent() {\n        return fetchWikipediaContent;\n      },\n      get injectWikipediaStyles() {\n        return injectWikipediaStyles;\n      },\n      get d3() {\n        return d3;\n      },\n      get renderChart() {\n        return renderChart;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["ref","onMounted","onUnmounted","LoadingSpinner","ErrorDisplay","WikipediaContent","fetchWikipediaContent","injectWikipediaStyles","d3","renderChart","props","__props","pageHtml","loading","error","selectedText","showPopup","divRef","currentView","visualizationLoading","handleSelection","selection","window","getSelection","rangeCount","range","getRangeAt","selectedHtml","cloneContents","tempDiv","document","createElement","appendChild","table","querySelector","classList","add","value","divId","innerHTML","text","toString","trim","closePopup","container","select","html","switchView","view","processText","api","post","data","console","alert","message","jsonData","json_data","log","data_type","renderNonVisualChart","chart_classification","pageTitle","then","catch","err","finally","addEventListener","removeEventListener"],"sources":["D:/vue_frame/vue_frame/wikitable-vue/client/src/components/base/MainComponent.vue"],"sourcesContent":["<template>\r\n\t<div :class=\"['div0', selectContentClass]\" :id=\"divId\" ref=\"divRef\">\r\n\t\t<h1>{{ pageTitle }}</h1>\r\n\r\n\t\t<!-- 加载动画 -->\r\n\t\t<LoadingSpinner v-if=\"loading\" />\r\n\r\n\t\t<!-- 错误信息 -->\r\n\t\t<ErrorDisplay\r\n\t\t\tv-else-if=\"error\"\r\n\t\t\t:error=\"error\"\r\n\t\t\t@retry=\"fetchWikipediaContent\" />\r\n\r\n\t\t<!-- 文章内容 -->\r\n\t\t<WikipediaContent\r\n\t\t\tv-else\r\n\t\t\t:pageHtml=\"pageHtml\"\r\n\t\t\t@mouseup=\"handleSelection\"\r\n\t\t\t:divId=\"divId\"\r\n\t\t\t:showPopup=\"showPopup[divId]\"\r\n\t\t\t:selectedText=\"selectedText[divId]\"\r\n\t\t\t:currentView=\"currentView\"\r\n\t\t\t@closePopup=\"closePopup\"\r\n\t\t\t@switchView=\"switchView\"\r\n\t\t\t:visualizationLoading=\"visualizationLoading\" />\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, onMounted, onUnmounted } from \"vue\";\r\n\timport LoadingSpinner from \"./LoadingSpinner.vue\";\r\n\timport ErrorDisplay from \"./ErrorDisplay.vue\";\r\n\timport WikipediaContent from \"./WikipediaContent.vue\";\r\n\timport { fetchWikipediaContent, injectWikipediaStyles } from \"@/js/apiUtils\";\r\n\timport * as d3 from \"d3\";\r\n\timport { renderChart } from \"@/js/chartUtils\";\r\n\r\n\tconst props = defineProps({\r\n\t\tpageTitle: String,\r\n\t\tdivId: String,\r\n\t\tselectContentClass: String\r\n\t});\r\n\r\n\tconst pageHtml = ref(\"\");\r\n\tconst loading = ref(true);\r\n\tconst error = ref(\"\");\r\n\tconst selectedText = ref({});\r\n\tconst showPopup = ref({});\r\n\tconst divRef = ref(null);\r\n\tconst currentView = ref(\"text\");\r\n\tconst visualizationLoading = ref(false);\r\n\r\n\tconst handleSelection = () => {\r\n\t\tconst selection = window.getSelection();\r\n\t\tif (!selection.rangeCount) return;\r\n\r\n\t\tconst range = selection.getRangeAt(0);\r\n\t\tconst selectedHtml = range.cloneContents();\r\n\r\n\t\tconst tempDiv = document.createElement(\"div\");\r\n\t\ttempDiv.appendChild(selectedHtml);\r\n\r\n\t\tconst table = tempDiv.querySelector(\"table\");\r\n\t\tif (table) {\r\n\t\t\ttable.classList.add(\"custom-table\");\r\n\t\t\tselectedText.value[props.divId] = tempDiv.innerHTML;\r\n\t\t} else {\r\n\t\t\tconst text = selection.toString().trim();\r\n\t\t\tif (!text) return;\r\n\t\t\tselectedText.value[props.divId] = text;\r\n\t\t}\r\n\r\n\t\tshowPopup.value[props.divId] = true;\r\n\t\tcurrentView.value = \"text\";\r\n\t};\r\n\r\n\tconst closePopup = () => {\r\n\t\tshowPopup.value[props.divId] = false;\r\n\t\tselectedText.value[props.divId] = \"\";\r\n\r\n\t\tconst container =\r\n\t\t\tprops.divId === \"div1\" ? \".chart-container1\" : \".chart-container2\";\r\n\t\td3.select(container).html(\"\");\r\n\t};\r\n\r\n\tconst switchView = async view => {\r\n\t\tcurrentView.value = view;\r\n\t\tif (view === \"visual\") {\r\n\t\t\tvisualizationLoading.value = true;\r\n\t\t\tawait processText();\r\n\t\t\tvisualizationLoading.value = false;\r\n\t\t}\r\n\t};\r\n\r\n\tasync function processText() {\r\n\t\ttry {\r\n\t\t\tapi.post(\r\n\t\t\t\t\"process_text\",\r\n\t\t\t\t{ text: selectedText.value[props.divId].toString().trim() }, // 使用对应 divId 的选中内容\r\n\t\t\t\tdata => {\r\n\t\t\t\t\tif (data.error) {\r\n\t\t\t\t\t\tconsole.error(\"后端返回的错误:\", data.error);\r\n\t\t\t\t\t\talert(`处理文章内容时出错: ${data.message}`);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst jsonData = data.json_data;\r\n\t\t\t\t\tconsole.log(\"后端返回的数据:\", jsonData);\r\n\r\n\t\t\t\t\t// 根据 divId 选择容器\r\n\t\t\t\t\tconst container =\r\n\t\t\t\t\t\tprops.divId === \"div1\" ? \".chart-container1\" : \".chart-container2\";\r\n\r\n\t\t\t\t\tif (data.data_type === \"Non-Visual\") {\r\n\t\t\t\t\t\trenderNonVisualChart(container, data, {\r\n\t\t\t\t\t\t\tmessage: \"当前数据无法可视化\"\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\trenderChart(jsonData, data.chart_classification);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"处理文章内容时出错:\", error);\r\n\t\t\talert(\"处理文章内容时出错，请稍后重试\");\r\n\t\t}\r\n\t}\r\n\r\n\tonMounted(() => {\r\n\t\tfetchWikipediaContent(props.pageTitle)\r\n\t\t\t.then(html => {\r\n\t\t\t\tpageHtml.value = html;\r\n\t\t\t\tinjectWikipediaStyles();\r\n\t\t\t})\r\n\t\t\t.catch(err => {\r\n\t\t\t\terror.value = err.message;\r\n\t\t\t})\r\n\t\t\t.finally(() => {\r\n\t\t\t\tloading.value = false;\r\n\t\t\t});\r\n\r\n\t\tif (divRef.value) {\r\n\t\t\tdivRef.value.addEventListener(\"mouseup\", handleSelection);\r\n\t\t}\r\n\t});\r\n\r\n\tonUnmounted(() => {\r\n\t\tif (divRef.value) {\r\n\t\t\tdivRef.value.removeEventListener(\"mouseup\", handleSelection);\r\n\t\t}\r\n\t});\r\n</script>\r\n\r\n<style scoped>\r\n\t.div0 {\r\n\t\tposition: relative;\r\n\t\twidth: 55%;\r\n\t\tmax-width: 100%;\r\n\t\tmax-height: 100%;\r\n\t\toverflow: auto;\r\n\t\tpadding: 20px;\r\n\t\tbackground-color: #ffffff;\r\n\t\tborder-radius: 12px;\r\n\t\tbox-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\r\n\t}\r\n\r\n\th1 {\r\n\t\ttext-align: center;\r\n\t}\r\n</style>\r\n"],"mappings":"AA6BC,SAASA,GAAG,EAAEC,SAAS,EAAEC,WAAW,QAAQ,KAAK;AACjD,OAAOC,cAAc,MAAM,sBAAsB;AACjD,OAAOC,YAAY,MAAM,oBAAoB;AAC7C,OAAOC,gBAAgB,MAAM,wBAAwB;AACrD,SAASC,qBAAqB,EAAEC,qBAAqB,QAAQ,eAAe;AAC5E,OAAO,KAAKC,EAAE,MAAM,IAAI;AACxB,SAASC,WAAW,QAAQ,iBAAiB;;;;;;;;;;;;;IAE7C,MAAMC,KAAK,GAAGC,OAIZ;IAEF,MAAMC,QAAQ,GAAGZ,GAAG,CAAC,EAAE,CAAC;IACxB,MAAMa,OAAO,GAAGb,GAAG,CAAC,IAAI,CAAC;IACzB,MAAMc,KAAK,GAAGd,GAAG,CAAC,EAAE,CAAC;IACrB,MAAMe,YAAY,GAAGf,GAAG,CAAC,CAAC,CAAC,CAAC;IAC5B,MAAMgB,SAAS,GAAGhB,GAAG,CAAC,CAAC,CAAC,CAAC;IACzB,MAAMiB,MAAM,GAAGjB,GAAG,CAAC,IAAI,CAAC;IACxB,MAAMkB,WAAW,GAAGlB,GAAG,CAAC,MAAM,CAAC;IAC/B,MAAMmB,oBAAoB,GAAGnB,GAAG,CAAC,KAAK,CAAC;IAEvC,MAAMoB,eAAe,GAAGA,CAAA,KAAM;MAC7B,MAAMC,SAAS,GAAGC,MAAM,CAACC,YAAY,CAAC,CAAC;MACvC,IAAI,CAACF,SAAS,CAACG,UAAU,EAAE;MAE3B,MAAMC,KAAK,GAAGJ,SAAS,CAACK,UAAU,CAAC,CAAC,CAAC;MACrC,MAAMC,YAAY,GAAGF,KAAK,CAACG,aAAa,CAAC,CAAC;MAE1C,MAAMC,OAAO,GAAGC,QAAQ,CAACC,aAAa,CAAC,KAAK,CAAC;MAC7CF,OAAO,CAACG,WAAW,CAACL,YAAY,CAAC;MAEjC,MAAMM,KAAK,GAAGJ,OAAO,CAACK,aAAa,CAAC,OAAO,CAAC;MAC5C,IAAID,KAAK,EAAE;QACVA,KAAK,CAACE,SAAS,CAACC,GAAG,CAAC,cAAc,CAAC;QACnCrB,YAAY,CAACsB,KAAK,CAAC3B,KAAK,CAAC4B,KAAK,CAAC,GAAGT,OAAO,CAACU,SAAS;MACpD,CAAC,MAAM;QACN,MAAMC,IAAI,GAAGnB,SAAS,CAACoB,QAAQ,CAAC,CAAC,CAACC,IAAI,CAAC,CAAC;QACxC,IAAI,CAACF,IAAI,EAAE;QACXzB,YAAY,CAACsB,KAAK,CAAC3B,KAAK,CAAC4B,KAAK,CAAC,GAAGE,IAAI;MACvC;MAEAxB,SAAS,CAACqB,KAAK,CAAC3B,KAAK,CAAC4B,KAAK,CAAC,GAAG,IAAI;MACnCpB,WAAW,CAACmB,KAAK,GAAG,MAAM;IAC3B,CAAC;IAED,MAAMM,UAAU,GAAGA,CAAA,KAAM;MACxB3B,SAAS,CAACqB,KAAK,CAAC3B,KAAK,CAAC4B,KAAK,CAAC,GAAG,KAAK;MACpCvB,YAAY,CAACsB,KAAK,CAAC3B,KAAK,CAAC4B,KAAK,CAAC,GAAG,EAAE;MAEpC,MAAMM,SAAS,GACdlC,KAAK,CAAC4B,KAAK,KAAK,MAAM,GAAG,mBAAmB,GAAG,mBAAmB;MACnE9B,EAAE,CAACqC,MAAM,CAACD,SAAS,CAAC,CAACE,IAAI,CAAC,EAAE,CAAC;IAC9B,CAAC;IAED,MAAMC,UAAU,GAAG,MAAMC,IAAI,IAAI;MAChC9B,WAAW,CAACmB,KAAK,GAAGW,IAAI;MACxB,IAAIA,IAAI,KAAK,QAAQ,EAAE;QACtB7B,oBAAoB,CAACkB,KAAK,GAAG,IAAI;QACjC,MAAMY,WAAW,CAAC,CAAC;QACnB9B,oBAAoB,CAACkB,KAAK,GAAG,KAAK;MACnC;IACD,CAAC;IAED,eAAeY,WAAWA,CAAA,EAAG;MAC5B,IAAI;QACHC,GAAG,CAACC,IAAI,CACP,cAAc,EACd;UAAEX,IAAI,EAAEzB,YAAY,CAACsB,KAAK,CAAC3B,KAAK,CAAC4B,KAAK,CAAC,CAACG,QAAQ,CAAC,CAAC,CAACC,IAAI,CAAC;QAAE,CAAC;QAAE;QAC7DU,IAAI,IAAI;UACP,IAAIA,IAAI,CAACtC,KAAK,EAAE;YACfuC,OAAO,CAACvC,KAAK,CAAC,UAAU,EAAEsC,IAAI,CAACtC,KAAK,CAAC;YACrCwC,KAAK,CAAC,cAAcF,IAAI,CAACG,OAAO,EAAE,CAAC;YACnC;UACD;UAEA,MAAMC,QAAQ,GAAGJ,IAAI,CAACK,SAAS;UAC/BJ,OAAO,CAACK,GAAG,CAAC,UAAU,EAAEF,QAAQ,CAAC;;UAEjC;UACA,MAAMZ,SAAS,GACdlC,KAAK,CAAC4B,KAAK,KAAK,MAAM,GAAG,mBAAmB,GAAG,mBAAmB;UAEnE,IAAIc,IAAI,CAACO,SAAS,KAAK,YAAY,EAAE;YACpCC,oBAAoB,CAAChB,SAAS,EAAEQ,IAAI,EAAE;cACrCG,OAAO,EAAE;YACV,CAAC,CAAC;UACH,CAAC,MAAM;YACN9C,WAAW,CAAC+C,QAAQ,EAAEJ,IAAI,CAACS,oBAAoB,CAAC;UACjD;QACD,CACD,CAAC;MACF,CAAC,CAAC,OAAO/C,KAAK,EAAE;QACfuC,OAAO,CAACvC,KAAK,CAAC,YAAY,EAAEA,KAAK,CAAC;QAClCwC,KAAK,CAAC,iBAAiB,CAAC;MACzB;IACD;IAEArD,SAAS,CAAC,MAAM;MACfK,qBAAqB,CAACI,KAAK,CAACoD,SAAS,CAAC,CACpCC,IAAI,CAACjB,IAAI,IAAI;QACblC,QAAQ,CAACyB,KAAK,GAAGS,IAAI;QACrBvC,qBAAqB,CAAC,CAAC;MACxB,CAAC,CAAC,CACDyD,KAAK,CAACC,GAAG,IAAI;QACbnD,KAAK,CAACuB,KAAK,GAAG4B,GAAG,CAACV,OAAO;MAC1B,CAAC,CAAC,CACDW,OAAO,CAAC,MAAM;QACdrD,OAAO,CAACwB,KAAK,GAAG,KAAK;MACtB,CAAC,CAAC;MAEH,IAAIpB,MAAM,CAACoB,KAAK,EAAE;QACjBpB,MAAM,CAACoB,KAAK,CAAC8B,gBAAgB,CAAC,SAAS,EAAE/C,eAAe,CAAC;MAC1D;IACD,CAAC,CAAC;IAEFlB,WAAW,CAAC,MAAM;MACjB,IAAIe,MAAM,CAACoB,KAAK,EAAE;QACjBpB,MAAM,CAACoB,KAAK,CAAC+B,mBAAmB,CAAC,SAAS,EAAEhD,eAAe,CAAC;MAC7D;IACD,CAAC,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}